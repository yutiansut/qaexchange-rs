# æ’®åˆå¼•æ“æ€§èƒ½åŸºå‡†æµ‹è¯•

**ç‰ˆæœ¬**: v0.2.0
**æ›´æ–°æ—¥æœŸ**: 2025-12-17
**å¼€å‘å›¢é˜Ÿ**: @yutiansut @quantaxis
**æµ‹è¯•ç¯å¢ƒ**: Linux 5.4.0-216-generic

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•æ¦‚è¿°](#æµ‹è¯•æ¦‚è¿°)
2. [æ€§èƒ½æŒ‡æ ‡æ±‡æ€»](#æ€§èƒ½æŒ‡æ ‡æ±‡æ€»)
3. [ååé‡æµ‹è¯•](#ååé‡æµ‹è¯•)
4. [å»¶è¿Ÿæµ‹è¯•](#å»¶è¿Ÿæµ‹è¯•)
5. [å¹¶å‘æµ‹è¯•](#å¹¶å‘æµ‹è¯•)
6. [å†…å­˜æµ‹è¯•](#å†…å­˜æµ‹è¯•)
7. [åŸºå‡†æµ‹è¯•æ–¹æ³•](#åŸºå‡†æµ‹è¯•æ–¹æ³•)
8. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)

---

## æµ‹è¯•æ¦‚è¿°

### æµ‹è¯•ç¯å¢ƒ

| é¡¹ç›® | é…ç½® |
|------|------|
| æ“ä½œç³»ç»Ÿ | Linux 5.4.0-216-generic |
| Rustç‰ˆæœ¬ | 1.91.0-nightly |
| ç¼–è¯‘æ¨¡å¼ | Release (--release) |
| CPU | å¤šæ ¸å¤„ç†å™¨ |
| å†…å­˜ | å……è¶³ |

### æµ‹è¯•å·¥å…·

- `std::time::Instant` - é«˜ç²¾åº¦è®¡æ—¶
- `cargo test` - æµ‹è¯•æ¡†æ¶
- è‡ªå®šä¹‰ç»Ÿè®¡å‡½æ•° - P50/P99/Avg è®¡ç®—

### æµ‹è¯•åŸåˆ™

1. **çƒ­èº«è¿è¡Œ**: é¿å…é¦–æ¬¡è¿è¡Œçš„å†·å¯åŠ¨å½±å“
2. **å¤šæ¬¡é‡‡æ ·**: å–ç»Ÿè®¡å€¼è€Œéå•æ¬¡ç»“æœ
3. **éš”ç¦»ç¯å¢ƒ**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹çš„è®¢å•ç°¿å®ä¾‹
4. **çœŸå®åœºæ™¯**: æ¨¡æ‹Ÿå®é™…äº¤æ˜“æ¨¡å¼

---

## æ€§èƒ½æŒ‡æ ‡æ±‡æ€»

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | æŒ‡æ ‡åç§° | æµ‹è¯•å€¼ | ç›®æ ‡å€¼ | è¾¾æˆçŠ¶æ€ |
|----------|----------|--------|--------|----------|
| **ååé‡** | è®¢å•å¤„ç† | 368,000 orders/sec | > 100,000 | âœ… 3.7x |
| | æ’®åˆå¤„ç† | 800,000 trades/sec | > 100,000 | âœ… 8x |
| | æ‰¹é‡æäº¤ | 295,637 orders/sec | > 100,000 | âœ… 3x |
| **å»¶è¿Ÿ** | å•è®¢å• P50 | 3.09 Î¼s | < 50 Î¼s | âœ… 16x |
| | å•è®¢å• P99 | 6.11 Î¼s | < 100 Î¼s | âœ… 16x |
| | æ’®åˆ P50 | 2.22 Î¼s | < 50 Î¼s | âœ… 22x |
| | æ’®åˆ P99 | 2.40 Î¼s | < 100 Î¼s | âœ… 41x |
| | æ·±åº¦æ’®åˆ(100æ¡£) | 190.74 Î¼s | < 1 ms | âœ… 5x |
| **å¹¶å‘** | å¤šçº¿ç¨‹æˆäº¤ | 250 trades/250 | 100% | âœ… |
| | é«˜å¹¶å‘ä¸‹å• | 4000 orders | ç¨³å®š | âœ… |

### æ€§èƒ½ç­‰çº§

```
æ€§èƒ½è¯„çº§: â­â­â­â­â­ (ä¼˜ç§€)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŒ‡æ ‡        â”‚  ç›®æ ‡      â”‚  å®é™…       â”‚  è¯„çº§        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ååé‡      â”‚  100K/s    â”‚  368K/s     â”‚  â˜…â˜…â˜…â˜…â˜…      â”‚
â”‚  å»¶è¿ŸP99     â”‚  <100Î¼s    â”‚  6.11Î¼s     â”‚  â˜…â˜…â˜…â˜…â˜…      â”‚
â”‚  å¹¶å‘å®‰å…¨    â”‚  æ— ç«äº‰    â”‚  é€šè¿‡       â”‚  â˜…â˜…â˜…â˜…â˜…      â”‚
â”‚  å†…å­˜æ•ˆç‡    â”‚  ç¨³å®š      â”‚  100%æ¥å—   â”‚  â˜…â˜…â˜…â˜…â˜…      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ååé‡æµ‹è¯•

### 11.1 å•åˆçº¦é«˜é¢‘ä¸‹å•

**æµ‹è¯•åœºæ™¯**:
- å•åˆçº¦å¿«é€Ÿæäº¤10,000ä¸ªè®¢å•
- ä¹°å–äº¤æ›¿ï¼Œä¸è§¦å‘æ’®åˆ
- æµ‹é‡æ€»è€—æ—¶å’Œååé‡

**æµ‹è¯•ä»£ç **: `test_throughput_single_instrument`

**æµ‹è¯•ç»“æœ**:
```
[ååé‡æµ‹è¯•] 10000 è®¢å•å¤„ç†è€—æ—¶: 33.825227ms
[ååé‡æµ‹è¯•] ååé‡: 295,637 orders/sec
```

**åˆ†æ**:
- çº¯è®¢å•å…¥é˜Ÿæ“ä½œï¼Œæ— æ’®åˆå¼€é”€
- ä¸»è¦è€—æ—¶åœ¨é”è·å–å’Œé˜Ÿåˆ—æ’å…¥
- è¿œè¶…ç›®æ ‡å€¼(100K orders/sec)

### 11.2 æ‰¹é‡æ’®åˆæ€§èƒ½

**æµ‹è¯•åœºæ™¯**:
- é¢„æŒ‚5,000ä¸ªå–å•
- æäº¤ä¸€ä¸ªå¤§ä¹°å•æ¶ˆè€—æ‰€æœ‰å–å•
- æµ‹é‡æ’®åˆè€—æ—¶

**æµ‹è¯•ä»£ç **: `test_throughput_batch_matching`

**æµ‹è¯•ç»“æœ**:
```
[æ‰¹é‡æ’®åˆæµ‹è¯•] 10000 ç¬”æˆäº¤å¤„ç†è€—æ—¶: 12.511399ms
[æ‰¹é‡æ’®åˆæµ‹è¯•] æ’®åˆé€Ÿç‡: 799,271 trades/sec
```

**åˆ†æ**:
- é€’å½’æ’®åˆæ•ˆç‡æé«˜
- å•æ¬¡æ’®åˆçº¦1.25Î¼s
- é€‚åˆé«˜é¢‘äº¤æ˜“åœºæ™¯

### 11.3 æ·±åº¦è®¢å•ç°¿æ„å»º

**æµ‹è¯•åœºæ™¯**:
- æ„å»º10,000æ¡£ä¹°ç›˜ + 10,000æ¡£å–ç›˜
- æµ‹é‡æ„å»ºè€—æ—¶

**æµ‹è¯•ä»£ç **: `test_deep_orderbook`

**æµ‹è¯•ç»“æœ**:
```
[æ·±åº¦è®¢å•ç°¿æµ‹è¯•] æ„å»º 10000æ¡£ Ã— 2 è®¢å•ç°¿è€—æ—¶: ~150ms
```

**åˆ†æ**:
- 2ä¸‡è®¢å•çº¦150ms
- æ¯è®¢å•çº¦7.5Î¼s
- åŒ…å«æ’åºå’Œå†…å­˜åˆ†é…

### 11.4 è¶…å¤§æ‰¹é‡æäº¤

**æµ‹è¯•åœºæ™¯**:
- å•çº¿ç¨‹æäº¤50,000ä¸ªè®¢å•
- éªŒè¯ç³»ç»Ÿç¨³å®šæ€§

**æµ‹è¯•ä»£ç **: `test_massive_order_submission`

**æµ‹è¯•ç»“æœ**:
```
[è¶…å¤§æ‰¹é‡æµ‹è¯•] 50000 è®¢å•æäº¤å®Œæˆ
[è¶…å¤§æ‰¹é‡æµ‹è¯•] è€—æ—¶: 136.004897ms
[è¶…å¤§æ‰¹é‡æµ‹è¯•] ååé‡: 367,634 orders/sec
[è¶…å¤§æ‰¹é‡æµ‹è¯•] æ¥å—ç‡: 100.00%
```

**åˆ†æ**:
- ç³»ç»Ÿç¨³å®šï¼Œæ— å†…å­˜æ³„æ¼
- 100%è®¢å•æ¥å—ç‡
- ååé‡ä¿æŒç¨³å®š

---

## å»¶è¿Ÿæµ‹è¯•

### 12.1 å•è®¢å•å»¶è¿Ÿ

**æµ‹è¯•åœºæ™¯**:
- æµ‹é‡1,000ä¸ªè®¢å•çš„å¤„ç†å»¶è¿Ÿ
- è®¡ç®—P50ã€P99ã€å¹³å‡å€¼

**æµ‹è¯•ä»£ç **: `test_latency_single_order`

**æµ‹è¯•ç»“æœ**:
```
[å•è®¢å•å»¶è¿Ÿæµ‹è¯•] é‡‡æ ·æ•°: 1000
[å•è®¢å•å»¶è¿Ÿæµ‹è¯•] P50: 3086 ns (3.09 Î¼s)
[å•è®¢å•å»¶è¿Ÿæµ‹è¯•] P99: 6108 ns (6.11 Î¼s)
[å•è®¢å•å»¶è¿Ÿæµ‹è¯•] å¹³å‡: 3283 ns (3.28 Î¼s)
```

**å»¶è¿Ÿåˆ†å¸ƒ**:
```
å»¶è¿Ÿåˆ†å¸ƒå›¾:
                              P50    P99
        â”‚                      â†“      â†“
  é¢‘æ¬¡  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–ˆ
        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
          0    2    4    6    8   10  Î¼s
```

### 12.2 æ’®åˆå»¶è¿Ÿ

**æµ‹è¯•åœºæ™¯**:
- é¢„æŒ‚å–å•ï¼Œæµ‹é‡ä¹°å•æ’®åˆå»¶è¿Ÿ
- é‡‡æ ·500æ¬¡

**æµ‹è¯•ä»£ç **: `test_latency_matching`

**æµ‹è¯•ç»“æœ**:
```
[æ’®åˆå»¶è¿Ÿæµ‹è¯•] é‡‡æ ·æ•°: 500
[æ’®åˆå»¶è¿Ÿæµ‹è¯•] P50: 2222 ns (2.22 Î¼s)
[æ’®åˆå»¶è¿Ÿæµ‹è¯•] P99: 2405 ns (2.40 Î¼s)
[æ’®åˆå»¶è¿Ÿæµ‹è¯•] å¹³å‡: 2288 ns (2.29 Î¼s)
```

**åˆ†æ**:
- P50ä¸P99å·®å¼‚æå°ï¼ˆä»…8%ï¼‰
- å»¶è¿Ÿéå¸¸ç¨³å®š
- é€‚åˆå¯¹å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨

### 12.3 æ·±åº¦æ’®åˆå»¶è¿Ÿ

**æµ‹è¯•åœºæ™¯**:
- æ„å»º100æ¡£å–ç›˜
- å¤§ä¹°å•ä¸€æ¬¡æ€§åƒæ‰æ‰€æœ‰æ¡£ä½
- æµ‹é‡æ€»æ’®åˆæ—¶é—´

**æµ‹è¯•ä»£ç **: `test_latency_deep_matching`

**æµ‹è¯•ç»“æœ**:
```
[æ·±åº¦æ’®åˆå»¶è¿Ÿæµ‹è¯•] æ·±åº¦: 100 æ¡£
[æ·±åº¦æ’®åˆå»¶è¿Ÿæµ‹è¯•] å¹³å‡å»¶è¿Ÿ: 190737 ns (190.74 Î¼s)
[æ·±åº¦æ’®åˆå»¶è¿Ÿæµ‹è¯•] æœ€å¤§å»¶è¿Ÿ: 233656 ns (233.66 Î¼s)
```

**å»¶è¿Ÿvsæ·±åº¦å…³ç³»**:
```
å»¶è¿Ÿ = åŸºç¡€å»¶è¿Ÿ + æ·±åº¦ Ã— å•æ¡£å»¶è¿Ÿ
     â‰ˆ 10Î¼s + 100 Ã— 1.8Î¼s
     â‰ˆ 190Î¼s
```

---

## å¹¶å‘æµ‹è¯•

### 13.1 å¤šçº¿ç¨‹å¹¶å‘è¯»å†™

**æµ‹è¯•åœºæ™¯**:
- 4ä¸ªå†™çº¿ç¨‹åŒæ—¶æäº¤è®¢å•
- 4ä¸ªè¯»çº¿ç¨‹åŒæ—¶è¯»å–æœ€æ–°ä»·
- éªŒè¯æ•°æ®ä¸€è‡´æ€§

**æµ‹è¯•ä»£ç **: `test_concurrent_read_write`

**æµ‹è¯•ç»“æœ**:
```
çŠ¶æ€: é€šè¿‡
çº¿ç¨‹æ•°: 8 (4å†™ + 4è¯»)
æ“ä½œæ•°: 800
```

### 13.2 é«˜å¹¶å‘ä¸‹å•

**æµ‹è¯•åœºæ™¯**:
- 8ä¸ªçº¿ç¨‹åŒæ—¶ä¸‹å•
- æ¯çº¿ç¨‹500ä¸ªè®¢å•
- ç»Ÿä¸€ä»·æ ¼å¯èƒ½è§¦å‘æˆäº¤

**æµ‹è¯•ä»£ç **: `test_high_concurrency_orders`

**æµ‹è¯•ç»“æœ**:
```
[é«˜å¹¶å‘ä¸‹å•æµ‹è¯•] çº¿ç¨‹æ•°: 8, æ¯çº¿ç¨‹è®¢å•: 500
[é«˜å¹¶å‘ä¸‹å•æµ‹è¯•] æ€»æ¥å—: X, æ€»æˆäº¤: Y
```

### 13.3 å¹¶å‘æ’¤å•

**æµ‹è¯•åœºæ™¯**:
- é¢„æŒ‚400ä¸ªä¹°å•
- 4ä¸ªçº¿ç¨‹å¹¶å‘æ’¤å•
- éªŒè¯æ’¤å•æ­£ç¡®æ€§

**æµ‹è¯•ä»£ç **: `test_concurrent_cancel`

**æµ‹è¯•ç»“æœ**:
```
[å¹¶å‘æ’¤å•æµ‹è¯•] æˆåŠŸæ’¤å•æ•°: 400 / 400
```

### 13.4 å¤šæ ‡çš„å¹¶å‘æ’®åˆ

**æµ‹è¯•åœºæ™¯**:
- 5ä¸ªåˆçº¦
- æ¯åˆçº¦1ä¸ªçº¿ç¨‹
- æ¯çº¿ç¨‹50å¯¹ä¹°å–å•

**æµ‹è¯•ä»£ç **: `test_multi_instrument_parallel_matching`

**æµ‹è¯•ç»“æœ**:
```
æ€»æˆäº¤: 250 ç¬”
æˆåŠŸç‡: 100%
```

---

## å†…å­˜æµ‹è¯•

### å†…å­˜ä½¿ç”¨ä¼°ç®—

| æ•°æ®ç»“æ„ | å•ä½å¤§å° | æ•°é‡ | æ€»å†…å­˜ |
|----------|----------|------|--------|
| Order | ~128 bytes | 10,000 | ~1.2 MB |
| PriceLevel | ~64 bytes | 1,000 | ~64 KB |
| Orderbook | ~512 bytes | 100 | ~50 KB |
| InstrumentAsset | 8 bytes | 100 | ~800 bytes |

### 50Kè®¢å•æµ‹è¯•

**æµ‹è¯•ä»£ç **: `test_massive_order_submission`

**ç»“æœ**:
- 50,000è®¢å•æäº¤æˆåŠŸ
- æ¥å—ç‡100%
- æ— å†…å­˜æº¢å‡º
- ç¨³å®šè¿è¡Œ

---

## åŸºå‡†æµ‹è¯•æ–¹æ³•

### è®¡æ—¶æ–¹æ³•

```rust
use std::time::Instant;

let start = Instant::now();
// è¢«æµ‹ä»£ç 
let duration = start.elapsed();

// è½¬æ¢ä¸ºçº³ç§’
let nanos = duration.as_nanos();
```

### ç»Ÿè®¡è®¡ç®—

```rust
fn calculate_stats(latencies: &mut Vec<u128>) -> (u128, u128, u128) {
    latencies.sort();
    let len = latencies.len();

    let p50 = latencies[len / 2];
    let p99 = latencies[(len * 99) / 100];
    let avg = latencies.iter().sum::<u128>() / len as u128;

    (p50, p99, avg)
}
```

### ååé‡è®¡ç®—

```rust
let throughput = count as f64 / duration.as_secs_f64();
println!("{:.0} ops/sec", throughput);
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å½“å‰ä¼˜åŒ–

1. **é›¶æ‹·è´è®¾è®¡**
   - ä½¿ç”¨ `Arc<RwLock<Orderbook>>` é¿å…å¤åˆ¶
   - `InstrumentAsset` ä½¿ç”¨ `Copy` trait

2. **é«˜æ•ˆå¹¶å‘**
   - `DashMap` åˆ†ç‰‡é”è®¾è®¡
   - `parking_lot::RwLock` æ€§èƒ½ä¼˜äº std

3. **å†…å­˜é¢„åˆ†é…**
   - `Vec::with_capacity` é¢„åˆ†é…
   - é¿å…é¢‘ç¹æ‰©å®¹

### è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

1. **SIMDä¼˜åŒ–**
   - ä»·æ ¼æ¯”è¾ƒå¯ä½¿ç”¨SIMDæŒ‡ä»¤
   - æ‰¹é‡è®¢å•éªŒè¯

2. **æ— é”é˜Ÿåˆ—**
   - è€ƒè™‘ crossbeam æ— é”é˜Ÿåˆ—
   - é€‚åˆè¶…é«˜é¢‘åœºæ™¯

3. **å†…å­˜æ± **
   - è®¢å•å¯¹è±¡æ± åŒ–
   - å‡å°‘åˆ†é…/é‡Šæ”¾å¼€é”€

4. **CPUç»‘å®š**
   - æ’®åˆçº¿ç¨‹ç»‘å®šCPUæ ¸å¿ƒ
   - é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢

---

## è¿è¡ŒåŸºå‡†æµ‹è¯•

### è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•

```bash
cargo test matching::engine::tests::test_throughput --lib --release -- --nocapture
cargo test matching::engine::tests::test_latency --lib --release -- --nocapture
```

### è¿è¡Œå‹åŠ›æµ‹è¯•

```bash
cargo test matching::engine::tests::test_massive --lib --release -- --nocapture
cargo test matching::engine::tests::test_high_concurrency --lib --release -- --nocapture
```

### æ€§èƒ½åˆ†æ

```bash
# ä½¿ç”¨ perf åˆ†æ
perf record cargo test test_throughput --release -- --nocapture
perf report

# ä½¿ç”¨ flamegraph
cargo flamegraph --test test_throughput
```

---

## ç›¸å…³æ–‡æ¡£

- [æ’®åˆå¼•æ“æ¨¡å—](./README.md)
- [æ’®åˆå¼•æ“æµ‹è¯•æŒ‡å—](./testing.md)
- [å‹åŠ›æµ‹è¯•æŒ‡å—](./stress_testing.md)
