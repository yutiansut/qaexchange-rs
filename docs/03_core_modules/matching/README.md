# æ’®åˆå¼•æ“æ¨¡å—

**ç‰ˆæœ¬**: v0.2.0
**æ›´æ–°æ—¥æœŸ**: 2025-12-17
**å¼€å‘å›¢é˜Ÿ**: @yutiansut @quantaxis

---

## ğŸ“‹ ç›®å½•

1. [æ¨¡å—æ¦‚è¿°](#æ¨¡å—æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ’®åˆç®—æ³•](#æ’®åˆç®—æ³•)
5. [APIå‚è€ƒ](#apiå‚è€ƒ)
6. [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
7. [æµ‹è¯•è¦†ç›–](#æµ‹è¯•è¦†ç›–)

---

## æ¨¡å—æ¦‚è¿°

æ’®åˆå¼•æ“æ˜¯ QAExchange çš„æ ¸å¿ƒäº¤æ˜“ç»„ä»¶ï¼Œè´Ÿè´£è®¢å•çš„æ¥æ”¶ã€åŒ¹é…å’Œæˆäº¤å¤„ç†ã€‚

### è®¾è®¡åŸåˆ™

- **é«˜æ€§èƒ½**: å•è®¢å•å¤„ç†å»¶è¿Ÿ P99 < 10Î¼s
- **é«˜åå**: æ”¯æŒ > 300,000 orders/sec
- **é›¶æ‹·è´**: åŸºäº qars::Orderbook çš„é›¶æ‹·è´æ’®åˆ
- **å¹¶å‘å®‰å…¨**: DashMap + RwLock æ— é”è®¾è®¡

### æ¨¡å—ç»“æ„

```
src/matching/
â”œâ”€â”€ mod.rs              # æ¨¡å—å…¥å£ï¼Œé‡å¯¼å‡º qars ç±»å‹
â”œâ”€â”€ engine.rs           # ExchangeMatchingEngine æ ¸å¿ƒå®ç°
â”œâ”€â”€ auction.rs          # é›†åˆç«ä»·å¢å¼º
â”œâ”€â”€ trade_recorder.rs   # æˆäº¤è®°å½•å™¨
â””â”€â”€ core/
    â””â”€â”€ mod.rs          # MatchingEngineCore (ç‹¬ç«‹è¿›ç¨‹ç‰ˆæœ¬)
```

---

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚       ExchangeMatchingEngine        â”‚
                     â”‚                                     â”‚
   OrderRequest      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  â”‚      DashMap<String,        â”‚   â”‚
                     â”‚  â”‚        Arc<RwLock<          â”‚   â”‚
                     â”‚  â”‚          Orderbook>>>       â”‚   â”‚
                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                     â”‚              â”‚                     â”‚
                     â”‚              â–¼                     â”‚
                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                     â”‚  â”‚    qars::Orderbook          â”‚   â”‚   Success/Failed
                     â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                     â”‚  â”‚    â”‚bid_queueâ”‚ask_queueâ”‚    â”‚   â”‚
                     â”‚  â”‚    â”‚(ä¹°ç›˜)   â”‚(å–ç›˜)   â”‚    â”‚   â”‚
                     â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                     â”‚                                     â”‚
                     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                     â”‚  â”‚      TradeRecorder          â”‚   â”‚   TradeRecord
                     â”‚  â”‚      (æˆäº¤è®°å½•å™¨)           â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
1. è®¢å•æ¥æ”¶
   OrderRouter â”€â”€> ExchangeMatchingEngine.process_order()

2. è®¢å•æ’®åˆ
   process_order() â”€â”€> Orderbook.process_order()
                   â”€â”€> order_matching() [é€’å½’æ’®åˆ]

3. ç»“æœå¤„ç†
   Success::Filled â”€â”€> TradeRecorder.record()
                   â”€â”€> TradeGateway.notify()

4. è¡Œæƒ…æ›´æ–°
   lastprice æ›´æ–° â”€â”€> MarketDataBroadcaster
```

---

## æ ¸å¿ƒç»„ä»¶

### ExchangeMatchingEngine

ä¸»æ’®åˆå¼•æ“ï¼Œç®¡ç†å¤šä¸ªåˆçº¦çš„è®¢å•ç°¿ã€‚

```rust
pub struct ExchangeMatchingEngine {
    /// åˆçº¦ä»£ç  -> è®¢å•ç°¿æ˜ å°„
    orderbooks: DashMap<String, Arc<RwLock<Orderbook<InstrumentAsset>>>>,

    /// æˆäº¤è®°å½•å™¨
    trade_recorder: Arc<TradeRecorder>,

    /// åˆçº¦æ˜¨æ”¶ç›˜ä»·
    prev_close_map: DashMap<String, f64>,

    /// å½“å‰äº¤æ˜“æ—¥
    trading_day: Arc<RwLock<String>>,
}
```

### InstrumentAsset

åˆçº¦èµ„äº§ç±»å‹ï¼Œä½¿ç”¨å­—ç¬¦ä¸²å“ˆå¸Œä½œä¸ºé«˜æ•ˆçš„ Copy ç±»å‹ã€‚

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub struct InstrumentAsset(u64);

impl InstrumentAsset {
    pub fn from_code(code: &str) -> Self {
        // ä½¿ç”¨ DefaultHasher ç”Ÿæˆç¨³å®šå“ˆå¸Œ
    }
}
```

### Orderbook (æ¥è‡ª qars)

ä»·æ ¼-æ—¶é—´ä¼˜å…ˆçš„è®¢å•ç°¿å®ç°ã€‚

```rust
pub struct Orderbook<Asset> {
    pub asset: Asset,
    pub lastprice: f64,
    pub trading_state: TradingState,
    bid_queue: OrderQueue<Asset>,  // ä¹°ç›˜ï¼šä»·æ ¼é™åº
    ask_queue: OrderQueue<Asset>,  // å–ç›˜ï¼šä»·æ ¼å‡åº
    sequence: AtomicU64,           // è®¢å•IDç”Ÿæˆå™¨
}
```

---

## æ’®åˆç®—æ³•

### ä»·æ ¼-æ—¶é—´ä¼˜å…ˆ (Price-Time Priority)

```
æ’®åˆè§„åˆ™ï¼š
1. ä»·æ ¼ä¼˜å…ˆ
   - ä¹°å•ï¼šé«˜ä»·ä¼˜å…ˆï¼ˆæ„¿æ„å‡ºæ›´é«˜ä»·çš„ä¹°æ–¹ä¼˜å…ˆæˆäº¤ï¼‰
   - å–å•ï¼šä½ä»·ä¼˜å…ˆï¼ˆæ„¿æ„æ¥å—æ›´ä½ä»·çš„å–æ–¹ä¼˜å…ˆæˆäº¤ï¼‰

2. æ—¶é—´ä¼˜å…ˆ
   - ç›¸åŒä»·æ ¼æ—¶ï¼Œå…ˆåˆ°çš„è®¢å•ä¼˜å…ˆæˆäº¤

ä¹°ç›˜æ’åºï¼šä»·æ ¼é™åº â†’ æ—¶é—´å‡åº
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 85200   â”‚ 85100   â”‚ 85000   â”‚  â† ä»·æ ¼ä»é«˜åˆ°ä½
â”‚ ts=100  â”‚ ts=101  â”‚ ts=102  â”‚  â† åŒä»·æ ¼æŒ‰æ—¶é—´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å–ç›˜æ’åºï¼šä»·æ ¼å‡åº â†’ æ—¶é—´å‡åº
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 85300   â”‚ 85400   â”‚ 85500   â”‚  â† ä»·æ ¼ä»ä½åˆ°é«˜
â”‚ ts=200  â”‚ ts=201  â”‚ ts=202  â”‚  â† åŒä»·æ ¼æŒ‰æ—¶é—´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ’®åˆæµç¨‹

```rust
fn process_order(order: OrderRequest) -> Vec<OrderProcessingResult> {
    match order {
        NewLimitOrder { direction, price, volume, .. } => {
            // 1. æ£€æŸ¥æ˜¯å¦å¯æ’®åˆ
            if can_match(direction, price) {
                // 2. é€’å½’æ’®åˆç›´åˆ°æ— æ³•ç»§ç»­
                order_matching(order, results);
            }

            // 3. å‰©ä½™æ•°é‡è¿›å…¥é˜Ÿåˆ—
            if remaining_volume > 0 {
                store_new_limit_order(order);
                results.push(Success::Accepted { .. });
            }
        }
        CancelOrder { id, direction } => {
            // æ’¤å•å¤„ç†
            process_order_cancel(id, direction);
        }
        // ...
    }
}
```

### æˆäº¤ç±»å‹

| ç±»å‹ | è¯´æ˜ | è§¦å‘æ¡ä»¶ |
|------|------|----------|
| `Accepted` | è®¢å•è¢«æ¥å— | è®¢å•è¿›å…¥é˜Ÿåˆ—ç­‰å¾… |
| `Filled` | å®Œå…¨æˆäº¤ | è®¢å•æ•°é‡å…¨éƒ¨æˆäº¤ |
| `PartiallyFilled` | éƒ¨åˆ†æˆäº¤ | è®¢å•æ•°é‡éƒ¨åˆ†æˆäº¤ |
| `Cancelled` | å·²æ’¤é”€ | æ’¤å•æˆåŠŸ |
| `Amended` | å·²ä¿®æ”¹ | æ”¹å•æˆåŠŸ |

---

## APIå‚è€ƒ

### åˆçº¦æ³¨å†Œ

```rust
/// æ³¨å†Œæ–°åˆçº¦
///
/// # å‚æ•°
/// - `instrument_id`: åˆçº¦ä»£ç ï¼ˆå¦‚ "cu2501"ï¼‰
/// - `prev_close`: æ˜¨æ”¶ç›˜ä»·
///
/// # è¿”å›
/// - `Ok(())`: æ³¨å†ŒæˆåŠŸ
/// - `Err(ExchangeError)`: æ³¨å†Œå¤±è´¥
pub fn register_instrument(
    &self,
    instrument_id: String,
    prev_close: f64,
) -> Result<(), ExchangeError>
```

### è®¢å•å¤„ç†

```rust
/// å¤„ç†è®¢å•è¯·æ±‚
///
/// # æ”¯æŒçš„è®¢å•ç±»å‹
/// - NewLimitOrder: é™ä»·å•
/// - NewMarketOrder: å¸‚ä»·å•
/// - CancelOrder: æ’¤å•
/// - AmendOrder: æ”¹å•
///
/// # è¿”å›
/// - Vec<OrderProcessingResult>: å¤„ç†ç»“æœåˆ—è¡¨
pub fn process_order(
    &self,
    instrument_id: &str,
    order: OrderRequest<InstrumentAsset>,
) -> Vec<OrderProcessingResult>
```

### çŠ¶æ€æŸ¥è¯¢

```rust
/// è·å–è®¢å•ç°¿
pub fn get_orderbook(&self, instrument_id: &str)
    -> Option<Arc<RwLock<Orderbook<InstrumentAsset>>>>

/// è·å–æ‰€æœ‰åˆçº¦åˆ—è¡¨
pub fn get_instruments(&self) -> Vec<String>

/// è·å–æœ€æ–°ä»·æ ¼
pub fn get_last_price(&self, instrument_id: &str) -> Option<f64>

/// è·å–æ˜¨æ”¶ç›˜ä»·
pub fn get_prev_close(&self, instrument_id: &str) -> Option<f64>
```

### äº¤æ˜“çŠ¶æ€æ§åˆ¶

```rust
/// è®¾ç½®äº¤æ˜“çŠ¶æ€
///
/// # çŠ¶æ€ç±»å‹
/// - PreAuctionPeriod: é›†åˆç«ä»·ç”³æŠ¥æœŸ
/// - AuctionOrder: é›†åˆç«ä»·ä¸‹å•æœŸ
/// - AuctionMatch: é›†åˆç«ä»·æ’®åˆæœŸ
/// - ContinuousTrading: è¿ç»­äº¤æ˜“
/// - Closed: ä¼‘å¸‚
pub fn set_trading_state(
    &self,
    instrument_id: &str,
    state: TradingState,
) -> Result<(), ExchangeError>
```

---

## æ€§èƒ½æŒ‡æ ‡

### åŸºå‡†æµ‹è¯•ç»“æœ

| æŒ‡æ ‡ | æµ‹è¯•å€¼ | ç›®æ ‡å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| è®¢å•ååé‡ | ~368,000 orders/sec | > 100,000 | âœ… |
| æ’®åˆååé‡ | ~800,000 trades/sec | > 100,000 | âœ… |
| å•è®¢å•å»¶è¿Ÿ P50 | 3.09 Î¼s | < 50 Î¼s | âœ… |
| å•è®¢å•å»¶è¿Ÿ P99 | 6.11 Î¼s | < 100 Î¼s | âœ… |
| æ’®åˆå»¶è¿Ÿ P50 | 2.22 Î¼s | < 50 Î¼s | âœ… |
| æ’®åˆå»¶è¿Ÿ P99 | 2.40 Î¼s | < 100 Î¼s | âœ… |
| æ·±åº¦æ’®åˆ(100æ¡£) | 190.74 Î¼s | < 1 ms | âœ… |

### å†…å­˜ä½¿ç”¨

- å•è®¢å•å†…å­˜å ç”¨: ~128 bytes
- 10ä¸‡è®¢å•ç°¿æ·±åº¦: ~15 MB
- 100åˆçº¦Ã—1ä¸‡æ·±åº¦: ~150 MB

---

## æµ‹è¯•è¦†ç›–

### æµ‹è¯•ç»Ÿè®¡

```
test result: ok. 76 passed; 0 failed; 0 ignored
```

### æµ‹è¯•åˆ†ç±»

| ç±»åˆ« | æµ‹è¯•æ•° | è¯´æ˜ |
|------|--------|------|
| åŸºç¡€åŠŸèƒ½ | 24 | InstrumentAssetã€Engineåˆ›å»ºç­‰ |
| ä¹°å–æ’®åˆ | 6 | ä¹°å…¥/å–å‡ºåŸºç¡€åœºæ™¯ |
| æˆäº¤ç±»å‹ | 5 | å®Œæ•´/éƒ¨åˆ†æˆäº¤ |
| æ’¤å•åœºæ™¯ | 5 | æ’¤å•æˆåŠŸ/å¤±è´¥ |
| ä»·æ ¼æ—¶é—´ä¼˜å…ˆ | 3 | ä¼˜å…ˆçº§éªŒè¯ |
| è®¢å•ç±»å‹ | 4 | é™ä»·/å¸‚ä»·/æ”¹å• |
| äº¤æ˜“çŠ¶æ€ | 3 | è¿ç»­/é›†åˆç«ä»·/ä¼‘å¸‚ |
| å¤šè´¦æˆ·æ’®åˆ | 3 | è·¨è´¦æˆ·æˆäº¤ |
| è¾¹ç•Œæ¡ä»¶ | 6 | å¼‚å¸¸åœºæ™¯å¤„ç† |
| å¤šæ ‡çš„å‹åŠ› | 3 | å¹¶å‘å¤šåˆçº¦ |
| å¤§è§„æ¨¡è®¢å• | 3 | åƒ/ä¸‡çº§è®¢å• |
| ååé‡æµ‹è¯• | 3 | æ€§èƒ½åŸºå‡† |
| å»¶è¿Ÿæµ‹è¯• | 3 | å»¶è¿Ÿç»Ÿè®¡ |
| å¹¶å‘å®‰å…¨ | 3 | å¤šçº¿ç¨‹æµ‹è¯• |
| æç«¯åœºæ™¯ | 4 | å‹åŠ›/æå€¼æµ‹è¯• |

è¯¦ç»†æµ‹è¯•æ–‡æ¡£è¯·å‚è€ƒï¼š[æ’®åˆå¼•æ“æµ‹è¯•æŒ‡å—](./testing.md)

---

## ç›¸å…³æ–‡æ¡£

- [æ’®åˆå¼•æ“æµ‹è¯•æŒ‡å—](./testing.md)
- [æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š](./benchmark.md)
- [é›†åˆç«ä»·æœºåˆ¶](./auction.md)
