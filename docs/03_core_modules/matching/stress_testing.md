# æ’®åˆå¼•æ“å‹åŠ›æµ‹è¯•æŒ‡å—

**ç‰ˆæœ¬**: v0.2.0
**æ›´æ–°æ—¥æœŸ**: 2025-12-17
**å¼€å‘å›¢é˜Ÿ**: @yutiansut @quantaxis

---

## ğŸ“‹ ç›®å½•

1. [æµ‹è¯•æ¦‚è¿°](#æµ‹è¯•æ¦‚è¿°)
2. [å¤šæ ‡çš„å‹åŠ›æµ‹è¯•](#å¤šæ ‡çš„å‹åŠ›æµ‹è¯•)
3. [å¤šç”¨æˆ·å¤šè´¦æˆ·æµ‹è¯•](#å¤šç”¨æˆ·å¤šè´¦æˆ·æµ‹è¯•)
4. [ååé‡å‹åŠ›æµ‹è¯•](#ååé‡å‹åŠ›æµ‹è¯•)
5. [å»¶è¿ŸåŸºå‡†æµ‹è¯•](#å»¶è¿ŸåŸºå‡†æµ‹è¯•)
6. [å¹¶å‘å®‰å…¨æµ‹è¯•](#å¹¶å‘å®‰å…¨æµ‹è¯•)
7. [æç«¯åœºæ™¯æµ‹è¯•](#æç«¯åœºæ™¯æµ‹è¯•)
8. [æµ‹è¯•æ‰§è¡ŒæŒ‡å—](#æµ‹è¯•æ‰§è¡ŒæŒ‡å—)
9. [é—®é¢˜æ’æŸ¥](#é—®é¢˜æ’æŸ¥)

---

## æµ‹è¯•æ¦‚è¿°

### å‹åŠ›æµ‹è¯•ç›®æ ‡

| æµ‹è¯•ç»´åº¦ | ç›®æ ‡ | éªŒè¯æ–¹æ³• |
|----------|------|----------|
| å¤šæ ‡çš„ | æ”¯æŒ100+åˆçº¦å¹¶å‘ | å¤šçº¿ç¨‹å¤šåˆçº¦æ’®åˆ |
| å¤šç”¨æˆ· | æ”¯æŒ10,000+ç”¨æˆ· | å¤§è§„æ¨¡è®¢å•æäº¤ |
| ååé‡ | > 100,000 orders/sec | é«˜é¢‘ä¸‹å•æµ‹è¯• |
| å»¶è¿Ÿ | P99 < 100Î¼s | å»¶è¿Ÿç»Ÿè®¡åˆ†æ |
| å¹¶å‘ | æ— æ•°æ®ç«äº‰ | å¤šçº¿ç¨‹è¯»å†™æµ‹è¯• |
| ç¨³å®šæ€§ | é•¿æ—¶é—´æ— å´©æºƒ | æç«¯åœºæ™¯æµ‹è¯• |

### æµ‹è¯•åˆ†ç±»

```
å‹åŠ›æµ‹è¯• (19ä¸ª)
â”œâ”€â”€ 9. å¤šæ ‡çš„å¹¶å‘æ’®åˆ (3ä¸ª)
â”‚   â”œâ”€â”€ test_multi_instrument_concurrent_orders
â”‚   â”œâ”€â”€ test_multi_instrument_parallel_matching
â”‚   â””â”€â”€ test_multi_instrument_isolation
â”œâ”€â”€ 10. å¤šç”¨æˆ·å¤šè´¦æˆ· (3ä¸ª)
â”‚   â”œâ”€â”€ test_large_scale_users
â”‚   â”œâ”€â”€ test_multi_account_order_distribution
â”‚   â””â”€â”€ test_cross_account_matching
â”œâ”€â”€ 11. ååé‡å‹åŠ› (3ä¸ª)
â”‚   â”œâ”€â”€ test_throughput_single_instrument
â”‚   â”œâ”€â”€ test_throughput_batch_matching
â”‚   â””â”€â”€ test_deep_orderbook
â”œâ”€â”€ 12. å»¶è¿ŸåŸºå‡† (3ä¸ª)
â”‚   â”œâ”€â”€ test_latency_single_order
â”‚   â”œâ”€â”€ test_latency_matching
â”‚   â””â”€â”€ test_latency_deep_matching
â”œâ”€â”€ 13. å¹¶å‘å®‰å…¨ (3ä¸ª)
â”‚   â”œâ”€â”€ test_concurrent_read_write
â”‚   â”œâ”€â”€ test_high_concurrency_orders
â”‚   â””â”€â”€ test_concurrent_cancel
â””â”€â”€ 14. æç«¯åœºæ™¯ (4ä¸ª)
    â”œâ”€â”€ test_extreme_price_range
    â”œâ”€â”€ test_orderbook_rebuild_after_mass_cancel
    â”œâ”€â”€ test_mixed_workload_stress
    â””â”€â”€ test_massive_order_submission
```

---

## å¤šæ ‡çš„å‹åŠ›æµ‹è¯•

### 9.1 å¤šæ ‡çš„åŒæ—¶ä¸‹å•

**æµ‹è¯•å‡½æ•°**: `test_multi_instrument_concurrent_orders`

**åœºæ™¯æè¿°**:
```
æ³¨å†Œ: 10ä¸ªåˆçº¦ (TEST0000 ~ TEST0009)
æ¯åˆçº¦:
  - 100ä¸ªä¹°å• (ä»·æ ¼990~891)
  - 100ä¸ªå–å• (ä»·æ ¼1010~1109)
æ€»è®¢å•: 2,000ä¸ª
```

**éªŒè¯ç‚¹**:
- [ ] æ‰€æœ‰åˆçº¦æ­£ç¡®æ³¨å†Œ
- [ ] è®¢å•æ­£ç¡®åˆ†é…åˆ°å„åˆçº¦
- [ ] æ— è·¨åˆçº¦æ•°æ®æ±¡æŸ“

**è¿è¡Œå‘½ä»¤**:
```bash
cargo test test_multi_instrument_concurrent_orders --lib -- --nocapture
```

### 9.2 å¤šæ ‡çš„å¹¶å‘æ’®åˆ

**æµ‹è¯•å‡½æ•°**: `test_multi_instrument_parallel_matching`

**åœºæ™¯æè¿°**:
```
åˆçº¦æ•°: 5ä¸ª (PARA0000 ~ PARA0004)
çº¿ç¨‹æ•°: 5ä¸ª (æ¯åˆçº¦1ä¸ªçº¿ç¨‹)
æ¯çº¿ç¨‹:
  - 50å¯¹ä¹°å–å•
  - æ¯å¯¹å…ˆæŒ‚å–å•å†ä¹°å•æˆäº¤
é¢„æœŸæˆäº¤: 250ç¬” (5 Ã— 50)
```

**æ¶æ„å›¾**:
```
Thread-0 â”€â”€â”¬â”€â”€> Orderbook(PARA0000) â”€â”€> 50 trades
Thread-1 â”€â”€â”¼â”€â”€> Orderbook(PARA0001) â”€â”€> 50 trades
Thread-2 â”€â”€â”¼â”€â”€> Orderbook(PARA0002) â”€â”€> 50 trades
Thread-3 â”€â”€â”¼â”€â”€> Orderbook(PARA0003) â”€â”€> 50 trades
Thread-4 â”€â”€â”´â”€â”€> Orderbook(PARA0004) â”€â”€> 50 trades
                                       â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                       250 trades
```

**éªŒè¯ç‚¹**:
- [ ] æ‰€æœ‰çº¿ç¨‹å®Œæˆæ— panic
- [ ] æˆäº¤æ•° = 250
- [ ] DashMap + RwLock å¹¶å‘å®‰å…¨

### 9.3 å¤šæ ‡çš„éš”ç¦»æ€§éªŒè¯

**æµ‹è¯•å‡½æ•°**: `test_multi_instrument_isolation`

**åœºæ™¯æè¿°**:
```
åˆçº¦A: æŒ‚ä¹°å• @1000 Ã— 100
åˆçº¦B: æŒ‚å–å• @1000 Ã— 100

éªŒè¯: åˆçº¦Bçš„å–å•ä¸åº”ä¸åˆçº¦Açš„ä¹°å•æˆäº¤
```

**éªŒè¯ç‚¹**:
- [ ] åˆçº¦Aä¹°å•çŠ¶æ€: Accepted
- [ ] åˆçº¦Bå–å•çŠ¶æ€: Accepted (è€ŒéFilled)
- [ ] æ— è·¨åˆçº¦æ’®åˆ

---

## å¤šç”¨æˆ·å¤šè´¦æˆ·æµ‹è¯•

### 10.1 å¤§é‡ç”¨æˆ·æ¨¡æ‹Ÿ

**æµ‹è¯•å‡½æ•°**: `test_large_scale_users`

**åœºæ™¯æè¿°**:
```
ç”¨æˆ·æ•°: 1,000
è®¢å•åˆ†å¸ƒ:
  - ç”¨æˆ·0-499: ä¹°å• (ä»·æ ¼900-949)
  - ç”¨æˆ·500-999: å–å• (ä»·æ ¼1051-1100)
è§¦å‘æ’®åˆ: å¤§ä¹°å• @1200 Ã— 500
```

**éªŒè¯ç‚¹**:
- [ ] 1,000ä¸ªè®¢å•å…¨éƒ¨æ¥å—
- [ ] å¤§ä¹°å•ä¸500+å–å•æˆäº¤
- [ ] ç³»ç»Ÿç¨³å®šæ— å´©æºƒ

### 10.2 å¤šè´¦æˆ·è®¢å•å‡è¡¡

**æµ‹è¯•å‡½æ•°**: `test_multi_account_order_distribution`

**åœºæ™¯æè¿°**:
```
è´¦æˆ·æ•°: 100
æ¯è´¦æˆ·è®¢å•: 10
æ€»è®¢å•: 1,000
è®¢å•ç±»å‹: äº¤æ›¿ä¹°å– (ä¸æˆäº¤)
```

**éªŒè¯ç‚¹**:
- [ ] æ¥å—è®¢å•æ•° = 1,000
- [ ] ä¹°å–è®¢å•å‡åŒ€åˆ†å¸ƒ

### 10.3 è´¦æˆ·é—´æˆäº¤éªŒè¯

**æµ‹è¯•å‡½æ•°**: `test_cross_account_matching`

**åœºæ™¯æè¿°**:
```
å–æ–¹è´¦æˆ·: 50ä¸ªï¼Œæ¯æˆ·å–å• @1000 Ã— 10
ä¹°æ–¹è´¦æˆ·: 50ä¸ªï¼Œæ¯æˆ·ä¹°å• @1000 Ã— 10
```

**éªŒè¯ç‚¹**:
- [ ] è·¨è´¦æˆ·æ­£å¸¸æˆäº¤
- [ ] æˆäº¤æ•° >= 50

---

## ååé‡å‹åŠ›æµ‹è¯•

### 11.1 å•åˆçº¦é«˜é¢‘ä¸‹å•

**æµ‹è¯•å‡½æ•°**: `test_throughput_single_instrument`

**æµ‹è¯•å‚æ•°**:
```rust
let order_count = 10_000;
// ä¹°å–äº¤æ›¿ï¼Œä»·æ ¼ä¸äº¤å‰ï¼Œä¸è§¦å‘æ’®åˆ
```

**æ€§èƒ½æŒ‡æ ‡**:
| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… |
|------|------|------|
| ååé‡ | > 100K/s | ~300K/s |
| æ€»è€—æ—¶ | < 100ms | ~33ms |

**è¿è¡Œå‘½ä»¤**:
```bash
cargo test test_throughput_single_instrument --lib --release -- --nocapture
```

### 11.2 æ‰¹é‡æ’®åˆæ€§èƒ½

**æµ‹è¯•å‡½æ•°**: `test_throughput_batch_matching`

**æµ‹è¯•å‚æ•°**:
```rust
// é¢„æŒ‚5,000å–å•
// å¤§ä¹°å•ä¸€æ¬¡æ¶ˆè€—æ‰€æœ‰
let aggressive_buy = orders::new_limit_order_request(
    asset, OrderDirection::BUY, 1200.0, 5000.0, ts + 10000,
);
```

**æ€§èƒ½æŒ‡æ ‡**:
| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… |
|------|------|------|
| æ’®åˆé€Ÿç‡ | > 100K/s | ~800K/s |
| å•æ¬¡æ’®åˆ | < 10Î¼s | ~1.25Î¼s |

### 11.3 æ·±åº¦è®¢å•ç°¿å‹åŠ›

**æµ‹è¯•å‡½æ•°**: `test_deep_orderbook`

**æµ‹è¯•å‚æ•°**:
```rust
let depth = 10_000; // æ¯è¾¹10,000æ¡£
```

**æ€§èƒ½æŒ‡æ ‡**:
| æŒ‡æ ‡ | å®é™… |
|------|------|
| æ„å»ºè€—æ—¶ | ~150ms |
| æ¯æ¡£è€—æ—¶ | ~7.5Î¼s |

---

## å»¶è¿ŸåŸºå‡†æµ‹è¯•

### 12.1 å•è®¢å•å»¶è¿Ÿ

**æµ‹è¯•å‡½æ•°**: `test_latency_single_order`

**æµ‹è¯•æ–¹æ³•**:
```rust
let sample_count = 1000;
for i in 0..sample_count {
    let start = Instant::now();
    ob.process_order(order);
    latencies.push(start.elapsed().as_nanos());
}
```

**ç»“æœç»Ÿè®¡**:
```
P50: 3.09 Î¼s
P99: 6.11 Î¼s
Avg: 3.28 Î¼s
```

### 12.2 æ’®åˆå»¶è¿Ÿ

**æµ‹è¯•å‡½æ•°**: `test_latency_matching`

**æµ‹è¯•æ–¹æ³•**:
```rust
// æ¯æ¬¡å…ˆæŒ‚å–å•ï¼Œå†æµ‹é‡ä¹°å•æ’®åˆå»¶è¿Ÿ
for i in 0..500 {
    ob.process_order(sell);  // æŒ‚å–å•
    let start = Instant::now();
    ob.process_order(buy);   // æ’®åˆ
    latencies.push(start.elapsed().as_nanos());
}
```

**ç»“æœç»Ÿè®¡**:
```
P50: 2.22 Î¼s
P99: 2.40 Î¼s
Avg: 2.29 Î¼s
```

### 12.3 æ·±åº¦æ’®åˆå»¶è¿Ÿ

**æµ‹è¯•å‡½æ•°**: `test_latency_deep_matching`

**æµ‹è¯•æ–¹æ³•**:
- æ„å»º100æ¡£å–ç›˜
- å¤§ä¹°å•åƒæ‰æ‰€æœ‰
- é‡å¤10è½®å–å¹³å‡

**ç»“æœç»Ÿè®¡**:
```
å¹³å‡: 190.74 Î¼s
æœ€å¤§: 233.66 Î¼s
```

---

## å¹¶å‘å®‰å…¨æµ‹è¯•

### 13.1 å¤šçº¿ç¨‹å¹¶å‘è¯»å†™

**æµ‹è¯•å‡½æ•°**: `test_concurrent_read_write`

**çº¿ç¨‹åˆ†é…**:
```
å†™çº¿ç¨‹ Ã— 4: æ¯çº¿ç¨‹æäº¤100è®¢å•
è¯»çº¿ç¨‹ Ã— 4: æ¯çº¿ç¨‹è¯»å–100æ¬¡lastprice
```

**éªŒè¯ç‚¹**:
- [ ] æ‰€æœ‰çº¿ç¨‹æ— panic
- [ ] æ— æ•°æ®ç«äº‰
- [ ] æ•°æ®ä¸€è‡´æ€§

### 13.2 é«˜å¹¶å‘ä¸‹å•

**æµ‹è¯•å‡½æ•°**: `test_high_concurrency_orders`

**å‚æ•°**:
```rust
let thread_count = 8;
let orders_per_thread = 500;
// å¥‡æ•°çº¿ç¨‹ä¹°ï¼Œå¶æ•°çº¿ç¨‹å–
// ç»Ÿä¸€ä»·æ ¼å¯èƒ½è§¦å‘æˆäº¤
```

**éªŒè¯ç‚¹**:
- [ ] æ€»è®¢å•æ•°æ­£ç¡®å¤„ç†
- [ ] ç»Ÿè®¡æ•°æ®ä¸€è‡´

### 13.3 å¹¶å‘æ’¤å•

**æµ‹è¯•å‡½æ•°**: `test_concurrent_cancel`

**æµç¨‹**:
```
1. æŒ‚å…¥400ä¸ªä¹°å•
2. æ”¶é›†æ‰€æœ‰order_id
3. åˆ†æˆ4ç»„ï¼Œ4çº¿ç¨‹å¹¶å‘æ’¤å•
4. éªŒè¯æ’¤å•æˆåŠŸæ•° >= 350
```

**éªŒè¯ç‚¹**:
- [ ] æ— é‡å¤æ’¤å•
- [ ] æ— æ¼æ’¤
- [ ] çº¿ç¨‹å®‰å…¨

---

## æç«¯åœºæ™¯æµ‹è¯•

### 14.1 ä»·æ ¼æç«¯æ³¢åŠ¨

**æµ‹è¯•å‡½æ•°**: `test_extreme_price_range`

**æµ‹è¯•èŒƒå›´**:
```rust
// æä½ä»·æ ¼
let low_price = 0.001;

// æé«˜ä»·æ ¼
let high_price = 9_999_999.99;
```

**éªŒè¯ç‚¹**:
- [ ] æ•°å€¼ç²¾åº¦æ­£ç¡®
- [ ] æ— æº¢å‡º
- [ ] è®¢å•æ­£å¸¸æ¥å—

### 14.2 å¤§é‡æ’¤å•åé‡å»º

**æµ‹è¯•å‡½æ•°**: `test_orderbook_rebuild_after_mass_cancel`

**æµç¨‹**:
```
ç¬¬ä¸€è½®:
  1. æŒ‚å…¥500ä¸ªä¹°å•
  2. å…¨éƒ¨æ’¤å•

ç¬¬äºŒè½®:
  1. é‡æ–°æŒ‚å…¥500ä¸ªä¹°å•
  2. éªŒè¯å…¨éƒ¨æ¥å—
```

**éªŒè¯ç‚¹**:
- [ ] å†…å­˜æ­£ç¡®é‡Šæ”¾
- [ ] è®¢å•IDç»§ç»­é€’å¢
- [ ] é˜Ÿåˆ—çŠ¶æ€æ­£ç¡®

### 14.3 æ··åˆå·¥ä½œè´Ÿè½½

**æµ‹è¯•å‡½æ•°**: `test_mixed_workload_stress`

**çº¿ç¨‹åˆ†é…**:
```
ä¸‹å•çº¿ç¨‹ Ã— 2: 300è®¢å•/çº¿ç¨‹ (ä¹°å–äº¤æ›¿ï¼Œä»·å·®1)
æ’®åˆçº¿ç¨‹ Ã— 2: 200è®¢å•/çº¿ç¨‹ (ç»Ÿä¸€ä»·æ ¼)
```

**æ¨¡æ‹Ÿåœºæ™¯**: çœŸå®äº¤æ˜“ç¯å¢ƒ

### 14.4 è¶…å¤§æ‰¹é‡æäº¤

**æµ‹è¯•å‡½æ•°**: `test_massive_order_submission`

**å‚æ•°**:
```rust
let order_count = 50_000;
```

**éªŒè¯ç‚¹**:
- [ ] 100%æ¥å—ç‡
- [ ] ç³»ç»Ÿç¨³å®š
- [ ] å†…å­˜å¯æ§

---

## æµ‹è¯•æ‰§è¡ŒæŒ‡å—

### è¿è¡Œå…¨éƒ¨å‹åŠ›æµ‹è¯•

```bash
# Debugæ¨¡å¼ (å¸¦ç¬¦å·ä¿¡æ¯)
cargo test matching::engine::tests --lib

# Releaseæ¨¡å¼ (æ€§èƒ½æµ‹è¯•)
cargo test matching::engine::tests --lib --release

# æ˜¾ç¤ºè¾“å‡º
cargo test matching::engine::tests --lib --release -- --nocapture
```

### è¿è¡Œç‰¹å®šç±»åˆ«æµ‹è¯•

```bash
# å¤šæ ‡çš„æµ‹è¯•
cargo test test_multi_instrument --lib --release -- --nocapture

# ååé‡æµ‹è¯•
cargo test test_throughput --lib --release -- --nocapture

# å»¶è¿Ÿæµ‹è¯•
cargo test test_latency --lib --release -- --nocapture

# å¹¶å‘æµ‹è¯•
cargo test test_concurrent --lib --release -- --nocapture

# æç«¯åœºæ™¯
cargo test test_extreme --lib --release -- --nocapture
cargo test test_massive --lib --release -- --nocapture
```

### æ€§èƒ½åˆ†æ

```bash
# CPU profiling (Linux)
perf record cargo test test_throughput --release -- --nocapture
perf report

# ç«ç„°å›¾
cargo install flamegraph
cargo flamegraph --test test_throughput

# å†…å­˜åˆ†æ
valgrind --tool=massif cargo test test_massive --release
```

---

## é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æµ‹è¯•è¶…æ—¶

**ç—‡çŠ¶**: æµ‹è¯•è¿è¡Œæ—¶é—´è¿‡é•¿

**æ’æŸ¥**:
```bash
# æ£€æŸ¥æ˜¯å¦æœ‰æ­»é”
RUST_BACKTRACE=1 cargo test test_name --lib -- --nocapture
```

**è§£å†³**: æ£€æŸ¥é”é¡ºåºï¼Œé¿å…å¾ªç¯ç­‰å¾…

#### 2. å†…å­˜æº¢å‡º

**ç—‡çŠ¶**: OOM é”™è¯¯

**æ’æŸ¥**:
```bash
# é™åˆ¶å†…å­˜
ulimit -v 4000000  # 4GB
cargo test test_massive --release
```

**è§£å†³**: å‡å°‘æµ‹è¯•è§„æ¨¡æˆ–ä¼˜åŒ–å†…å­˜ä½¿ç”¨

#### 3. å¹¶å‘æµ‹è¯•å¤±è´¥

**ç—‡çŠ¶**: æ–­è¨€å¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´

**æ’æŸ¥**:
```bash
# å¤šæ¬¡è¿è¡ŒæŸ¥çœ‹æ˜¯å¦ç¨³å®š
for i in {1..10}; do
  cargo test test_concurrent --release
done
```

**è§£å†³**: æ£€æŸ¥åŸå­æ“ä½œå’Œé”ä½¿ç”¨

### è°ƒè¯•æŠ€å·§

```rust
// æ·»åŠ è°ƒè¯•è¾“å‡º
println!("[DEBUG] order_id={}, price={}, volume={}", id, price, volume);

// ä½¿ç”¨ env_logger
RUST_LOG=debug cargo test test_name -- --nocapture

// æ¡ä»¶æ–­ç‚¹
if order_id == 12345 {
    panic!("Debug point reached");
}
```

---

## å‹åŠ›æµ‹è¯•æ£€æŸ¥æ¸…å•

### å‘å¸ƒå‰æ£€æŸ¥

- [ ] æ‰€æœ‰76ä¸ªæµ‹è¯•é€šè¿‡
- [ ] ååé‡ > 100K orders/sec
- [ ] å»¶è¿Ÿ P99 < 100Î¼s
- [ ] å¹¶å‘æµ‹è¯•æ— æ•°æ®ç«äº‰
- [ ] 50Kè®¢å•æµ‹è¯•100%æ¥å—ç‡
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®š
- [ ] æ— panicæˆ–å´©æºƒ

### CI/CD é›†æˆ

```yaml
# .github/workflows/test.yml
jobs:
  stress-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run stress tests
        run: |
          cargo test matching::engine::tests --lib --release
        timeout-minutes: 10
```

---

## ç›¸å…³æ–‡æ¡£

- [æ’®åˆå¼•æ“æ¨¡å—](./README.md)
- [æ’®åˆå¼•æ“æµ‹è¯•æŒ‡å—](./testing.md)
- [æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š](./benchmark.md)
