# QAExchange-RS 2025-2026 技术路线图

> **版本**: v1.0.0
> **创建时间**: 2025-12-18
> **维护者**: @yutiansut @quantaxis

## 目录

- [执行摘要](#执行摘要)
- [已完成里程碑](#已完成里程碑)
- [2025 H1 路线图](#2025-h1-路线图)
- [2025 H2 路线图](#2025-h2-路线图)
- [2026 愿景](#2026-愿景)
- [技术债务清理](#技术债务清理)
- [风险与依赖](#风险与依赖)

---

## 执行摘要

QAExchange-RS 是一个高性能量化交易所系统，基于 Rust 构建，已完成 Phase 1-11 的核心功能开发。本路线图规划了 2025-2026 年的技术演进方向，重点包括：

- **生产就绪性** (Phase 12): 可观测性、监控、告警
- **网络层安全** (Phase 13): gRPC + TLS/mTLS 加密通信
- **分布式架构** (Phase 14-15): 多节点集群、分片路由
- **智能化演进** (Phase 16+): AI 风控、策略托管

### 核心指标目标

| 指标 | 当前值 | 2025 Q2 目标 | 2025 Q4 目标 | 2026 目标 |
|------|--------|--------------|--------------|-----------|
| 订单吞吐量 | 100K ops/s | 200K ops/s | 500K ops/s | 1M ops/s |
| 撮合延迟 P99 | < 100μs | < 50μs | < 20μs | < 10μs |
| 账户并发数 | 10,000 | 50,000 | 100,000 | 500,000 |
| 系统可用性 | 99.9% | 99.95% | 99.99% | 99.999% |

---

## 已完成里程碑

### Phase 1-2: 存储基础 ✅

**完成时间**: 2025-10

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| WAL 持久化 | ✅ 完成 | 78K entries/s |
| CRC32 数据完整性 | ✅ 完成 | < 1μs/record |
| OLTP MemTable (SkipMap) | ✅ 完成 | P99 < 10μs write |
| OLAP MemTable (Arrow2) | ✅ 完成 | 列式存储 |
| SSTable (rkyv/Parquet) | ✅ 完成 | mmap 零拷贝读取 |

### Phase 3-5: 存储优化 ✅

**完成时间**: 2025-10

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| Leveled Compaction | ✅ 完成 | 后台异步 |
| Bloom Filter | ✅ 完成 | 1% FP, ~100ns lookup |
| Checkpoint/Recovery | ✅ 完成 | < 5s 恢复 |
| iceoryx2 框架 | ✅ 完成 | 零拷贝 IPC |

### Phase 6-7: 复制与优化 ✅

**完成时间**: 2025-10

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| 主从复制协议 | ✅ 完成 | < 10ms 延迟 |
| Raft-inspired 选举 | ✅ 完成 | < 500ms 故障转移 |
| 心跳检测 | ✅ 完成 | 100ms 间隔 |
| mmap 零拷贝读取 | ✅ 完成 | P99 < 50μs |

### Phase 8: 查询引擎 ✅

**完成时间**: 2025-10-04

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| Polars SQL 查询 | ✅ 完成 | < 10ms (100 rows) |
| 时间序列聚合 | ✅ 完成 | < 100ms |
| Parquet 列式扫描 | ✅ 完成 | > 1GB/s |
| 结构化查询 API | ✅ 完成 | LazyFrame 优化 |

### Phase 9: 市场数据增强 ✅

**完成时间**: 2025-10-05

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| L1 市场数据缓存 | ✅ 完成 | < 10μs (cached) |
| Tick 数据 WAL 持久化 | ✅ 完成 | 自动记录 |
| 市场数据恢复 | ✅ 完成 | < 5s 恢复 |
| WebSocket 背压控制 | ✅ 完成 | 500 队列阈值 |

### Phase 10: 用户管理 ✅

**完成时间**: 2025-10-06

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| User-Account 分离 | ✅ 完成 | 1:N 关系 |
| JWT 认证 | ✅ 完成 | bcrypt 加密 |
| RBAC 权限 | ✅ 完成 | 角色管理 |
| 用户 WAL 恢复 | ✅ 完成 | 崩溃恢复 |

### Phase 11: 性能优化 II ✅

**完成时间**: 2025-11-26

| 功能 | 状态 | 性能指标 |
|------|------|----------|
| 二级索引系统 | ✅ 完成 | ~50ns add, ~2μs 复合查询 |
| 动态压缩策略 | ✅ 完成 | ZSTD/LZ4/Snappy |
| Factor WAL 集成 | ✅ 完成 | > 200K ops/s |
| 因子 Checkpoint | ✅ 完成 | ZSTD Level 3 |
| 复制监控增强 | ✅ 完成 | CPU/Memory/Disk |

---

## 2025 H1 路线图

### Phase 12: 生产就绪 (2025 Q1)

**目标**: 构建生产级可观测性和监控系统

#### 12.1 OpenTelemetry 分布式追踪

```
┌─────────────────────────────────────────────────────────────┐
│                    Observability Stack                       │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   Tracing    │  │   Metrics    │  │   Logging    │       │
│  │              │  │              │  │              │       │
│  │ OpenTelemetry│  │  Prometheus  │  │  tracing-    │       │
│  │    OTLP      │  │   Exporter   │  │  subscriber  │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
│         │                 │                 │                │
│         └─────────────────┴─────────────────┘                │
│                           ↓                                  │
│                    ┌──────────────┐                          │
│                    │   Grafana    │                          │
│                    │  Dashboard   │                          │
│                    └──────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

**任务清单**:

| 任务 | 优先级 | 状态 | 预计完成 |
|------|--------|------|----------|
| OTLP 导出器实现 | P0 | ✅ 完成 | 2025-12-18 |
| Span 自动传播 | P0 | 🚧 进行中 | 2025-01 |
| 采样率配置 | P1 | 📋 计划中 | 2025-01 |
| Jaeger 集成 | P1 | 📋 计划中 | 2025-01 |
| 关键路径分析 | P2 | 📋 计划中 | 2025-02 |

**代码位置**: `src/observability/tracing.rs`

#### 12.2 Prometheus 指标导出

**核心指标**:

```rust
// 交易指标
qaexchange_orders_total{instrument, direction}
qaexchange_trades_total{instrument}
qaexchange_order_latency_seconds{quantile}

// 存储指标
qaexchange_wal_writes_total
qaexchange_memtable_size_bytes
qaexchange_sstable_reads_total

// 系统指标
qaexchange_connections_active
qaexchange_memory_usage_bytes
qaexchange_cpu_usage_percent
```

**任务清单**:

| 任务 | 优先级 | 状态 | 预计完成 |
|------|--------|------|----------|
| prometheus crate 集成 | P0 | 📋 计划中 | 2025-01 |
| 交易指标实现 | P0 | 📋 计划中 | 2025-01 |
| 存储指标实现 | P1 | 📋 计划中 | 2025-02 |
| HTTP /metrics 端点 | P0 | 📋 计划中 | 2025-01 |

#### 12.3 Grafana 监控大盘

**预置面板**:

1. **交易概览**: 订单量、成交量、撮合延迟
2. **存储状态**: WAL 大小、MemTable 占用、SSTable 数量
3. **系统健康**: CPU、内存、磁盘 IO
4. **复制状态**: 主从延迟、心跳状态

**位置**: `config/grafana/dashboards/`

---

### Phase 13: 网络层 (2025 Q2)

**目标**: 实现安全的 gRPC 网络通信

#### 13.1 gRPC 服务定义

```protobuf
// proto/exchange.proto
service ExchangeService {
  // 订单服务
  rpc SubmitOrder(OrderRequest) returns (OrderResponse);
  rpc CancelOrder(CancelRequest) returns (CancelResponse);

  // 行情服务
  rpc SubscribeQuotes(QuoteSubscription) returns (stream Quote);
  rpc GetOrderBook(OrderBookRequest) returns (OrderBook);

  // 账户服务
  rpc QueryAccount(AccountRequest) returns (AccountInfo);
  rpc QueryPositions(PositionRequest) returns (stream Position);

  // 复制服务 (内部)
  rpc ReplicateLog(stream LogEntry) returns (ReplicateResponse);
  rpc RequestVote(VoteRequest) returns (VoteResponse);
}
```

**任务清单**:

| 任务 | 优先级 | 状态 | 预计完成 |
|------|--------|------|----------|
| Proto 定义 | P0 | 📋 计划中 | 2025-03 |
| tonic 服务实现 | P0 | 📋 计划中 | 2025-03 |
| 流式行情推送 | P1 | 📋 计划中 | 2025-04 |
| 复制 RPC | P1 | 📋 计划中 | 2025-04 |

#### 13.2 TLS/mTLS 安全通信

```
┌─────────────────────────────────────────────────────────────┐
│                    TLS Security Layer                        │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                   Certificate Chain                    │   │
│  │                                                        │   │
│  │    ┌────────┐     ┌────────┐     ┌────────┐          │   │
│  │    │  Root  │ ──> │  CA    │ ──> │ Server │          │   │
│  │    │  CA    │     │ Cert   │     │ Cert   │          │   │
│  │    └────────┘     └────────┘     └────────┘          │   │
│  │                                                        │   │
│  │    mTLS: Server Cert + Client Cert (双向认证)          │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  支持:                                                       │
│  - 自签名证书生成 (rcgen)                                    │
│  - PEM/DER 格式                                              │
│  - 证书自动轮换                                              │
│  - CRL/OCSP 吊销检查                                         │
└─────────────────────────────────────────────────────────────┘
```

**代码位置**: `src/replication/tls.rs`

**任务清单**:

| 任务 | 优先级 | 状态 | 预计完成 |
|------|--------|------|----------|
| 证书生成器 | P0 | ✅ 完成 | 2025-12-18 |
| TLS 配置构建器 | P0 | ✅ 完成 | 2025-12-18 |
| mTLS 双向认证 | P0 | ✅ 完成 | 2025-12-18 |
| tonic TLS 集成 | P1 | 📋 计划中 | 2025-04 |
| 证书轮换机制 | P2 | 📋 计划中 | 2025-05 |

#### 13.3 网络集成测试

**测试场景**:

1. 证书生成与验证
2. TLS 握手性能
3. mTLS 客户端认证
4. 并发连接压力测试
5. 网络分区恢复

**代码位置**: `tests/network_integration_test.rs`

---

## 2025 H2 路线图

### Phase 14: 分布式架构 (2025 Q3)

**目标**: 实现多节点集群部署

#### 14.1 一致性哈希分片

```
┌─────────────────────────────────────────────────────────────┐
│                 Consistent Hash Ring                         │
│                                                              │
│                        ┌───┐                                 │
│                    ┌───┤ 0 ├───┐                             │
│                    │   └───┘   │                             │
│                ┌───┴───┐   ┌───┴───┐                         │
│                │  vn0  │   │  vn1  │  Node A                 │
│                └───────┘   └───────┘                         │
│           ┌───┐                         ┌───┐                │
│           │vn5│                         │vn2│ Node B         │
│           └───┘                         └───┘                │
│                ┌───────┐   ┌───────┐                         │
│                │  vn4  │   │  vn3  │  Node C                 │
│                └───┬───┘   └───┬───┘                         │
│                    │   ┌───┐   │                             │
│                    └───┤360├───┘                             │
│                        └───┘                                 │
└─────────────────────────────────────────────────────────────┘
```

**分片策略**:

- 按 instrument_id 分片 (默认)
- 按 user_id 分片 (账户数据)
- 自定义分片函数支持

**代码位置**: `src/cluster/` (待实现)

#### 14.2 分布式事务

**两阶段提交 (2PC)**:

```
Coordinator                    Participants
    │                              │
    │──── PREPARE ────────────────>│
    │<─── PREPARED ────────────────│
    │                              │
    │──── COMMIT ─────────────────>│
    │<─── ACK ─────────────────────│
```

**Saga 模式** (长事务):

```
T1 → T2 → T3 → ... → Tn
│     │     │           │
C1    C2    C3         Cn  (补偿操作)
```

#### 14.3 跨节点查询

**查询路由**:

1. 解析查询条件
2. 确定目标分片
3. 并行查询各分片
4. 合并结果集

### Phase 15: 高可用增强 (2025 Q4)

**目标**: 实现 99.99% 可用性

#### 15.1 多 Raft 组

```
┌─────────────────────────────────────────────────────────────┐
│                   Multi-Raft Architecture                    │
│                                                              │
│   ┌─────────────────┐  ┌─────────────────┐                  │
│   │  Raft Group 1   │  │  Raft Group 2   │                  │
│   │  (IF/IH/IC)     │  │  (cu/au/ag)     │                  │
│   │                 │  │                 │                  │
│   │  Leader: N1     │  │  Leader: N2     │                  │
│   │  Follower: N2,N3│  │  Follower: N1,N3│                  │
│   └─────────────────┘  └─────────────────┘                  │
│                                                              │
│   ┌─────────────────┐  ┌─────────────────┐                  │
│   │  Raft Group 3   │  │  Raft Group 4   │                  │
│   │  (Account)      │  │  (Meta)         │                  │
│   └─────────────────┘  └─────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

#### 15.2 自动扩缩容

**扩容流程**:

1. 新节点加入集群
2. 数据迁移 (渐进式)
3. 路由表更新
4. 流量切换

**缩容流程**:

1. 标记节点下线
2. 数据迁移
3. 移除节点
4. 更新路由

#### 15.3 跨数据中心复制

**异步复制**:

```
DC1 (Primary)                 DC2 (Secondary)
    │                              │
    │──── Async Replication ──────>│
    │                              │
    │<─── Ack (async) ─────────────│
```

**RPO/RTO 目标**:

- RPO (恢复点目标): < 1 秒
- RTO (恢复时间目标): < 30 秒

---

## 2026 愿景

### Phase 16: 智能化演进

#### 16.1 AI 风控引擎

```
┌─────────────────────────────────────────────────────────────┐
│                    AI Risk Engine                            │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  Real-time   │  │  Anomaly     │  │  Predictive  │       │
│  │  Monitoring  │  │  Detection   │  │  Model       │       │
│  │              │  │              │  │              │       │
│  │ - Position   │  │ - Isolation  │  │ - VaR        │       │
│  │ - Margin     │  │   Forest     │  │ - ES         │       │
│  │ - P&L        │  │ - LSTM       │  │ - Stress     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

**能力**:

- 实时异常检测
- 市场操纵识别
- 风险预警
- 自动止损

#### 16.2 策略托管平台

**架构**:

```
┌─────────────────────────────────────────────────────────────┐
│                Strategy Hosting Platform                     │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │   Strategy   │  │   Sandbox    │  │  Performance │       │
│  │   Runtime    │  │   Executor   │  │   Analyzer   │       │
│  │              │  │              │  │              │       │
│  │ - WASM       │  │ - Paper      │  │ - Sharpe     │       │
│  │ - Docker     │  │   Trading    │  │ - Drawdown   │       │
│  │ - Native     │  │ - Backtest   │  │ - Alpha      │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

#### 16.3 全球化部署

**多区域架构**:

```
                    Global Load Balancer
                           │
          ┌────────────────┼────────────────┐
          │                │                │
     ┌────┴────┐      ┌────┴────┐      ┌────┴────┐
     │  APAC   │      │  EMEA   │      │  AMER   │
     │  Region │      │  Region │      │  Region │
     └─────────┘      └─────────┘      └─────────┘
```

---

## 技术债务清理

### 高优先级

| 债务 | 描述 | 预计工时 | 计划时间 |
|------|------|----------|----------|
| WebSocket 认证 | Token 验证未实现 | 3d | 2025 Q1 |
| ClickHouse 集成 | MongoDB 外的另一持久化选项 | 5d | 2025 Q1 |
| 测试覆盖率 | 目标 80% | 10d | 2025 Q1-Q2 |

### 中优先级

| 债务 | 描述 | 预计工时 | 计划时间 |
|------|------|----------|----------|
| API 文档自动生成 | OpenAPI 3.0 | 3d | 2025 Q2 |
| 配置热更新 | 无需重启 | 5d | 2025 Q2 |
| 日志结构化 | JSON 格式日志 | 2d | 2025 Q2 |

### 低优先级

| 债务 | 描述 | 预计工时 | 计划时间 |
|------|------|----------|----------|
| 代码重构 | 模块边界清理 | 10d | 2025 H2 |
| 依赖升级 | Polars 0.51+ | 2d | 持续 |

---

## 风险与依赖

### 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Polars 版本兼容 | 查询引擎 | 中 | 固定版本，渐进升级 |
| iceoryx2 生产稳定性 | IPC 性能 | 低 | 备选 Unix socket |
| TLS 性能开销 | 网络延迟 | 低 | 连接池复用 |

### 外部依赖

| 依赖 | 用途 | 版本 | 状态 |
|------|------|------|------|
| qars | 核心交易逻辑 | local | 活跃维护 |
| tokio | 异步运行时 | 1.35 | 稳定 |
| tonic | gRPC 框架 | 0.12 | 稳定 |
| polars | 查询引擎 | 0.51 | 活跃更新 |

### 团队资源

| 角色 | 当前 | 2025 Q2 需求 | 2025 Q4 需求 |
|------|------|--------------|--------------|
| 后端工程师 | 2 | 3 | 4 |
| DevOps | 1 | 1 | 2 |
| QA | 1 | 2 | 2 |

---

## 里程碑时间线

```
2024 Q4    2025 Q1    2025 Q2    2025 Q3    2025 Q4    2026
   │          │          │          │          │          │
   │  Phase   │  Phase   │  Phase   │  Phase   │  Phase   │
   │  1-11    │   12     │   13     │   14     │   15     │   16+
   │  ✅      │  🚧      │  📋      │  📋      │  📋      │  🔮
   │          │          │          │          │          │
   │ 存储     │ 可观测   │ 网络层   │ 分布式   │ 高可用   │ 智能化
   │ 复制     │ 监控     │ TLS     │ 分片     │ 扩缩容   │ AI风控
   │ 查询     │ 告警     │ gRPC    │ 路由     │ 跨DC     │ 策略
   │          │          │          │          │          │
```

---

## 版本发布计划

| 版本 | 发布时间 | 主要功能 |
|------|----------|----------|
| v1.5.0 | 2025-01 | OpenTelemetry, Prometheus |
| v1.6.0 | 2025-03 | gRPC 服务, TLS |
| v1.7.0 | 2025-06 | 分布式分片 |
| v2.0.0 | 2025-12 | 高可用集群 |
| v3.0.0 | 2026 H2 | AI 风控 |

---

## 附录

### A. 性能基准测试计划

| 测试场景 | 工具 | 指标 | 频率 |
|----------|------|------|------|
| 订单吞吐 | criterion | ops/s | 每 PR |
| 撮合延迟 | criterion | P50/P99 | 每 PR |
| WAL 写入 | criterion | MB/s | 每周 |
| 查询响应 | wrk | RPS/Latency | 每周 |

### B. 监控告警规则

```yaml
# 示例 Prometheus 告警规则
groups:
  - name: qaexchange
    rules:
      - alert: HighOrderLatency
        expr: qaexchange_order_latency_seconds{quantile="0.99"} > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Order latency P99 > 100ms"

      - alert: LowDiskSpace
        expr: qaexchange_disk_usage_percent > 80
        for: 10m
        labels:
          severity: critical
```

### C. 参考文档

- [系统架构](../02_architecture/system_overview.md)
- [存储设计](../03_core_modules/storage/)
- [复制系统](../03_core_modules/storage/replication.md)
- [查询引擎](../03_core_modules/storage/query_engine.md)

---

**文档版本**: v1.0.0
**最后更新**: 2025-12-18
**维护者**: @yutiansut @quantaxis
