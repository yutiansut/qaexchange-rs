# WebSocket + HTTP å¹¶å‘ä¸‹å•å®‰å…¨æ€§åˆ†æ

**æ—¥æœŸ**: 2025-10-06
**åˆ†æå¯¹è±¡**: OrderRouter å¹¶å‘ä¸‹å•åœºæ™¯

---

## ğŸ”´ é—®é¢˜æè¿°

å½“è´¦æˆ·åŒæ—¶æ¥æ”¶ **WebSocket ä¸‹å•** å’Œ **HTTP ä¸‹å•** è¯·æ±‚æ—¶ï¼Œå¯èƒ½å­˜åœ¨ç«æ€æ¡ä»¶å¯¼è‡´ä½™é¢é€æ”¯ã€‚

### åœºæ™¯ç¤ºä¾‹

```
åˆå§‹çŠ¶æ€ï¼šè´¦æˆ·ä½™é¢ 10000 å…ƒ

æ—¶åˆ»1: WebSocket çº¿ç¨‹è¯»å–ä½™é¢ (10000)ï¼Œé£æ§æ£€æŸ¥é€šè¿‡ï¼ˆéœ€è¦5000ï¼‰
æ—¶åˆ»2: HTTP çº¿ç¨‹è¯»å–ä½™é¢ (10000)ï¼Œé£æ§æ£€æŸ¥é€šè¿‡ï¼ˆéœ€è¦6000ï¼‰
æ—¶åˆ»3: WebSocket çº¿ç¨‹è·å–å†™é”ï¼Œå†»ç»“5000ï¼Œä½™é¢å˜5000
æ—¶åˆ»4: HTTP çº¿ç¨‹è·å–å†™é”ï¼Œå†»ç»“6000ï¼Œä½™é¢å˜ -1000 âŒ
```

**ç»“æœ**: è´¦æˆ·é€æ”¯ 1000 å…ƒï¼

---

## ğŸ” å½“å‰å®ç°åˆ†æ

### ä»£ç æµç¨‹

**OrderRouter.submit_order()** (`src/exchange/order_router.rs:200-280`)

```rust
pub fn submit_order(&self, req: SubmitOrderRequest) -> SubmitOrderResponse {
    // 1. ç”Ÿæˆè®¢å•ID (çº¿ç¨‹å®‰å…¨)
    let order_id = self.generate_order_id();

    // 2. é£æ§æ£€æŸ¥ (é—®é¢˜ç‚¹ï¼)
    match self.risk_checker.check(&risk_check_req) {
        Ok(RiskCheckResult::Pass) => { /* ç»§ç»­ */ }
        Ok(RiskCheckResult::Reject { .. }) => { return Reject; }
    }

    // 3. è·å–è´¦æˆ·å†™é”
    let account = self.account_mgr.get_default_account(&req.user_id)?;
    let mut acc = account.write();  // å†™é”ä¿æŠ¤

    // 4. å†»ç»“èµ„é‡‘
    let qa_order_result = acc.send_order(...);
}
```

**PreTradeCheck.check_funds()** (`src/risk/pre_trade_check.rs:196-227`)

```rust
fn check_funds(
    &self,
    account: &Arc<RwLock<QA_Account>>,
    req: &OrderCheckRequest,
) -> Result<Option<RiskCheckResult>, ExchangeError> {
    let acc = account.read();  // åªè·å–è¯»é”ï¼

    let required_funds = /* è®¡ç®—æ‰€éœ€èµ„é‡‘ */;

    if acc.accounts.available < required_funds {
        return Ok(Some(RiskCheckResult::Reject { ... }));
    }

    Ok(None)  // æ£€æŸ¥é€šè¿‡ï¼Œé‡Šæ”¾è¯»é”
}
```

### é—®é¢˜æ ¹æº

**è¯»é”ä¸å†™é”ä¹‹é—´å­˜åœ¨æ—¶é—´çª—å£**ï¼š

```
[è¯»é”] é£æ§æ£€æŸ¥ä½™é¢ -> [é‡Šæ”¾è¯»é”] -> [æ—¶é—´çª—å£] -> [å†™é”] å†»ç»“èµ„é‡‘
                                      â†‘
                              å…¶ä»–çº¿ç¨‹å¯èƒ½åœ¨è¿™é‡Œæ’å…¥ï¼
```

---

## âœ… å½“å‰å®‰å…¨æ€§è¯„ä¼°

### éƒ¨åˆ†å®‰å…¨çš„æƒ…å†µ

**QA_Account.send_order()** å†…éƒ¨å¯èƒ½æœ‰äºŒæ¬¡æ£€æŸ¥ï¼ˆéœ€è¦éªŒè¯ qars æºç ï¼‰ï¼š

```rust
// qars/src/qaaccount/account.rs (å‡è®¾)
pub fn send_order(&mut self, ...) -> Result<...> {
    // å¯èƒ½å­˜åœ¨çš„äºŒæ¬¡æ£€æŸ¥
    if self.accounts.available < required_margin {
        return Err("Insufficient funds");
    }

    // å†»ç»“èµ„é‡‘
    self.accounts.available -= required_margin;
    Ok(...)
}
```

**å¦‚æœå­˜åœ¨äºŒæ¬¡æ£€æŸ¥**ï¼Œåˆ™ï¼š
- âœ… ä¸ä¼šå¯¼è‡´ä½™é¢é€æ”¯
- âŒ ä½†ä¼šå¯¼è‡´è®¢å•æ‹’ç»ä¸ä¸€è‡´ï¼ˆé£æ§é€šè¿‡ä½†å®é™…å¤±è´¥ï¼‰

**å¦‚æœä¸å­˜åœ¨äºŒæ¬¡æ£€æŸ¥**ï¼Œåˆ™ï¼š
- âŒ å¯èƒ½å¯¼è‡´ä½™é¢é€æ”¯
- ğŸ”´ **ä¸¥é‡é—®é¢˜**

---

## ğŸ›¡ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šåŒé‡æ£€æŸ¥é”æ¨¡å¼ï¼ˆæ¨èï¼‰âœ…

åœ¨å†™é”å†…å†æ¬¡æ£€æŸ¥ä½™é¢ï¼š

```rust
// OrderRouter.submit_order() ä¿®æ”¹å
pub fn submit_order(&self, req: SubmitOrderRequest) -> SubmitOrderResponse {
    // 1. ç”Ÿæˆè®¢å•ID
    let order_id = self.generate_order_id();

    // 2. é£æ§æ£€æŸ¥ï¼ˆç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œä½¿ç”¨è¯»é”ï¼‰
    match self.risk_checker.check(&risk_check_req) {
        Ok(RiskCheckResult::Pass) => { /* ç»§ç»­ */ }
        Ok(RiskCheckResult::Reject { .. }) => { return Reject; }
    }

    // 3. è·å–è´¦æˆ·å†™é”
    let account = self.account_mgr.get_default_account(&req.user_id)?;
    let mut acc = account.write();

    // âœ… æ–°å¢ï¼šç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆåœ¨å†™é”å†…ï¼‰
    let required_funds = self.calculate_required_funds(&req);
    if acc.accounts.available < required_funds {
        return SubmitOrderResponse {
            success: false,
            error_message: Some("Insufficient funds (double-check)".to_string()),
            error_code: Some(4001),
            ...
        };
    }

    // 4. å†»ç»“èµ„é‡‘ï¼ˆå†™é”ä¿æŠ¤ï¼‰
    let qa_order_result = acc.send_order(...);
}
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨é¿å…ç«æ€æ¡ä»¶
- âœ… æ€§èƒ½å½±å“å°ï¼ˆåªå¢åŠ ä¸€æ¬¡è®¡ç®—ï¼‰
- âœ… å®ç°ç®€å•

**ç¼ºç‚¹**:
- âŒ éœ€è¦åœ¨ä¸¤å¤„ç»´æŠ¤ç›¸åŒçš„è®¡ç®—é€»è¾‘

---

### æ–¹æ¡ˆBï¼šé£æ§æ£€æŸ¥æ—¶è·å–å†™é”

```rust
// PreTradeCheck.check_funds() ä¿®æ”¹å
fn check_funds(
    &self,
    account: &Arc<RwLock<QA_Account>>,
    req: &OrderCheckRequest,
) -> Result<Option<RiskCheckResult>, ExchangeError> {
    let mut acc = account.write();  // ä½¿ç”¨å†™é”

    let required_funds = /* è®¡ç®—æ‰€éœ€èµ„é‡‘ */;

    if acc.accounts.available < required_funds {
        return Ok(Some(RiskCheckResult::Reject { ... }));
    }

    // âœ… ç›´æ¥å†»ç»“èµ„é‡‘ï¼ˆåœ¨åŒä¸€ä¸ªé”å†…ï¼‰
    acc.accounts.available -= required_funds;
    acc.accounts.frozen_margin += required_funds;

    Ok(None)
}
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨é¿å…ç«æ€æ¡ä»¶
- âœ… é€»è¾‘é›†ä¸­

**ç¼ºç‚¹**:
- âŒ æ€§èƒ½è¾ƒå·®ï¼ˆè¯»é”å˜å†™é”ï¼Œå¹¶å‘åº¦é™ä½ï¼‰
- âŒ æ¶æ„å¤æ‚ï¼ˆé£æ§æ¨¡å—éœ€è¦ä¿®æ”¹è´¦æˆ·çŠ¶æ€ï¼‰

---

### æ–¹æ¡ˆCï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰

```rust
pub struct QA_Account {
    pub accounts: AccountInfo,
    pub version: AtomicU64,  // ç‰ˆæœ¬å·
}

// OrderRouter.submit_order() ä¿®æ”¹å
pub fn submit_order(&self, req: SubmitOrderRequest) -> SubmitOrderResponse {
    loop {
        // 1. è¯»å–ç‰ˆæœ¬å·
        let account = self.account_mgr.get_default_account(&req.user_id)?;
        let version_before = account.read().version.load(Ordering::Acquire);

        // 2. é£æ§æ£€æŸ¥
        match self.risk_checker.check(&risk_check_req) { ... }

        // 3. å°è¯•æ›´æ–°ï¼ˆæ¯”è¾ƒç‰ˆæœ¬å·ï¼‰
        let mut acc = account.write();
        let version_current = acc.version.load(Ordering::Acquire);

        if version_before != version_current {
            // ç‰ˆæœ¬å·å˜åŒ–ï¼Œé‡è¯•
            continue;
        }

        // 4. å†»ç»“èµ„é‡‘å¹¶æ›´æ–°ç‰ˆæœ¬å·
        acc.send_order(...);
        acc.version.fetch_add(1, Ordering::Release);
        break;
    }
}
```

**ä¼˜ç‚¹**:
- âœ… é«˜å¹¶å‘æ€§èƒ½
- âœ… æ— é”ç«äº‰

**ç¼ºç‚¹**:
- âŒ å®ç°å¤æ‚
- âŒ éœ€è¦ä¿®æ”¹ qars çš„ QA_Account ç»“æ„

---

## ğŸ“‹ æ¨èæ–¹æ¡ˆ

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å®æ–½ï¼‰

**æ–¹æ¡ˆAï¼šåŒé‡æ£€æŸ¥é”æ¨¡å¼**

```diff
// src/exchange/order_router.rs:270-280

let mut acc = account.write();
+
+ // äºŒæ¬¡æ£€æŸ¥ä½™é¢ï¼ˆåœ¨å†™é”å†…ï¼‰
+ let required_funds = self.calculate_required_funds(&req);
+ if acc.accounts.available < required_funds {
+     return SubmitOrderResponse {
+         success: false,
+         order_id: Some(order_id),
+         status: Some("rejected".to_string()),
+         error_message: Some(format!(
+             "Insufficient funds: available={:.2}, required={:.2}",
+             acc.accounts.available, required_funds
+         )),
+         error_code: Some(4001),
+     };
+ }
+
let qa_order_result = acc.send_order(...);
```

### ä¸­æœŸæ–¹æ¡ˆï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

**æ”¹è¿› qars QA_Account.send_order()**ï¼š
- ç¡®ä¿å†…éƒ¨æœ‰ä½™é¢æ£€æŸ¥
- è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯

### é•¿æœŸæ–¹æ¡ˆï¼ˆæ¶æ„å‡çº§ï¼‰

**è€ƒè™‘å¼•å…¥äº‹åŠ¡æœºåˆ¶**ï¼š
- ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼ˆå¦‚æœæŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼‰
- æˆ–å®ç°å†…å­˜äº‹åŠ¡ï¼ˆMVCCï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### å¹¶å‘å‹æµ‹è„šæœ¬

```rust
#[tokio::test]
async fn test_concurrent_order_submission() {
    let order_router = Arc::new(OrderRouter::new(...));
    let account_mgr = Arc::new(AccountManager::new());

    // å¼€æˆ·ï¼Œåˆå§‹ä½™é¢10000
    account_mgr.open_account(OpenAccountRequest {
        user_id: "test_user".to_string(),
        init_cash: 10000.0,
        ...
    }).unwrap();

    // å¹¶å‘æäº¤10ä¸ªè®¢å•ï¼Œæ¯ä¸ªéœ€è¦2000
    let mut handles = vec![];
    for i in 0..10 {
        let router = order_router.clone();
        let handle = tokio::spawn(async move {
            router.submit_order(SubmitOrderRequest {
                user_id: "test_user".to_string(),
                volume: 2000.0,
                ...
            })
        });
        handles.push(handle);
    }

    let results = futures::future::join_all(handles).await;

    // éªŒè¯ï¼šæœ€å¤š5ä¸ªè®¢å•æˆåŠŸï¼ˆ10000 / 2000 = 5ï¼‰
    let success_count = results.iter().filter(|r| r.success).count();
    assert!(success_count <= 5, "Account overdraft detected!");
}
```

---

## ğŸ“Š æ€§èƒ½å½±å“è¯„ä¼°

### æ–¹æ¡ˆAï¼ˆåŒé‡æ£€æŸ¥ï¼‰æ€§èƒ½å¼€é”€

| æ“ä½œ | å»¶è¿Ÿå¢åŠ  | ååé‡å½±å“ |
|------|----------|------------|
| ä½™é¢è®¡ç®— | +10Î¼s | å¿½ç•¥ä¸è®¡ |
| å†™é”æŒæœ‰æ—¶é—´ | +10Î¼s | <1% |
| **æ€»ä½“å½±å“** | **<0.1%** | **å¯å¿½ç•¥** |

### ç»“è®º

âœ… **æ–¹æ¡ˆA å¯¹æ€§èƒ½å‡ ä¹æ— å½±å“ï¼Œå¼ºçƒˆæ¨èç«‹å³å®æ–½**

---

## ğŸ¯ è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œ
1. âœ… å®Œæˆå¹¶å‘å®‰å…¨æ€§åˆ†ææ–‡æ¡£
2. â³ å®ç°æ–¹æ¡ˆAï¼ˆåŒé‡æ£€æŸ¥é”ï¼‰
3. â³ ç¼–å†™å¹¶å‘å‹æµ‹ç”¨ä¾‹
4. â³ éªŒè¯ä¿®å¤æ•ˆæœ

### åç»­ä¼˜åŒ–
5. æ£€æŸ¥ qars QA_Account.send_order() å®ç°
6. æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆé”ç«äº‰ç»Ÿè®¡ï¼‰
7. è¯„ä¼°æ˜¯å¦éœ€è¦æ›´é«˜çº§æ–¹æ¡ˆ

---

## ğŸ“ æ€»ç»“

### å½“å‰çŠ¶æ€
- ğŸ”´ **å­˜åœ¨ç«æ€æ¡ä»¶é£é™©**
- âš ï¸ å¯èƒ½å¯¼è‡´ä½™é¢é€æ”¯ï¼ˆå¦‚æœ qars æ— äºŒæ¬¡æ£€æŸ¥ï¼‰
- âœ… é”æœºåˆ¶æ­£ç¡®ï¼ˆRwLock æ­£å¸¸å·¥ä½œï¼‰

### æ¨èæ–¹æ¡ˆ
- âœ… **æ–¹æ¡ˆAï¼ˆåŒé‡æ£€æŸ¥é”ï¼‰**ï¼šç®€å•ã€å®‰å…¨ã€é«˜æ•ˆ
- ğŸ“‹ å®æ–½éš¾åº¦ï¼šä½
- â±ï¸ é¢„è®¡æ—¶é—´ï¼š30 åˆ†é’Ÿ

### é£é™©è¯„çº§
- **ä¿®å¤å‰**: ğŸ”´ é«˜é£é™©ï¼ˆå¯èƒ½èµ„é‡‘é€æ”¯ï¼‰
- **ä¿®å¤å**: ğŸŸ¢ ä½é£é™©ï¼ˆå®Œå…¨é¿å…ç«æ€ï¼‰

---

**æ–‡æ¡£åˆ›å»º**: 2025-10-06
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜
