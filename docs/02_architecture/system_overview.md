# ç³»ç»Ÿæ¶æ„è®¾è®¡

**ç‰ˆæœ¬**: v0.4.0
**æ›´æ–°æ—¥æœŸ**: 2025-11-24 (æ–°å¢å› å­è®¡ç®—ã€é›†ç¾¤ç®¡ç†ã€DSLè§£ææ¨¡å—)
**å¼€å‘å›¢é˜Ÿ**: @yutiansut @quantaxis

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#æ ¸å¿ƒè®¾è®¡åŸåˆ™)
3. [åˆ†å±‚æ¶æ„](#åˆ†å±‚æ¶æ„)
4. [ç®¡ç†ç«¯æ¶æ„](#ç®¡ç†ç«¯æ¶æ„)
5. [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
6. [å¹¶å‘æ¨¡å‹](#å¹¶å‘æ¨¡å‹)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)
9. [å®‰å…¨è®¾è®¡](#å®‰å…¨è®¾è®¡)
10. [æ•°æ®åè®®](#æ•°æ®åè®®)

---

## æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚ (Client Layer)                    â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  Web å‰ç«¯     â”‚  â”‚  ç§»åŠ¨ç«¯ App   â”‚  â”‚  äº¤æ˜“ç»ˆç«¯     â”‚          â”‚
â”‚   â”‚  (React/Vue) â”‚  â”‚  (Flutter)   â”‚  â”‚  (Desktop)   â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚          â”‚                 â”‚                 â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
       HTTP REST         WebSocket         WebSocket
           â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœåŠ¡å±‚ (Service Layer)                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  HTTP Server (Actix-web)        Port: 8080              â”‚    â”‚
â”‚   â”‚  â”œâ”€â”€ CORS Middleware                                    â”‚    â”‚
â”‚   â”‚  â”œâ”€â”€ Logger Middleware                                  â”‚    â”‚
â”‚   â”‚  â”œâ”€â”€ Compression (Gzip)                                 â”‚    â”‚
â”‚   â”‚  â””â”€â”€ Routes:                                            â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /api/account/* (è´¦æˆ·ç®¡ç†)                       â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /api/order/* (è®¢å•ç®¡ç†)                         â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /api/position/* (æŒä»“æŸ¥è¯¢)                      â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /api/market/* (å¸‚åœºæ•°æ®)                        â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /admin/instruments/* (åˆçº¦ç®¡ç†) ğŸ”§              â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /admin/settlement/* (ç»“ç®—ç®¡ç†) ğŸ”§               â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ /admin/risk/* (é£æ§ç®¡ç†) ğŸ”§                     â”‚    â”‚
â”‚   â”‚      â””â”€â”€ /monitoring/* (ç³»ç»Ÿç›‘æ§) ğŸ”§                     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚  WebSocket Server (Actix-web-actors)  Port: 8081        â”‚    â”‚
â”‚   â”‚  â”œâ”€â”€ Session Management (Actor Model)                   â”‚    â”‚
â”‚   â”‚  â”œâ”€â”€ Authentication & Authorization                     â”‚    â”‚
â”‚   â”‚  â”œâ”€â”€ Heartbeat (5s interval, 10s timeout)              â”‚    â”‚
â”‚   â”‚  â””â”€â”€ Message Routing:                                   â”‚    â”‚
â”‚   â”‚      â”œâ”€â”€ Trading Messages (submit/cancel/query)         â”‚    â”‚
â”‚   â”‚      â””â”€â”€ Subscription (trade/orderbook/account)         â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡å±‚ (Business Layer)                       â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  OrderRouter     â”‚  â”‚  TradeGateway    â”‚  â”‚  Settlement  â”‚  â”‚
â”‚   â”‚  (è®¢å•è·¯ç”±)       â”‚  â”‚  (æˆäº¤ç½‘å…³)       â”‚  â”‚  (ç»“ç®—å¼•æ“)   â”‚  â”‚
â”‚   â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚  â”‚
â”‚   â”‚ â€¢ è®¢å•æ¥æ”¶        â”‚  â”‚ â€¢ æˆäº¤é€šçŸ¥        â”‚  â”‚ â€¢ æ—¥ç»ˆç»“ç®—   â”‚  â”‚
â”‚   â”‚ â€¢ é£æ§æ£€æŸ¥        â”‚  â”‚ â€¢ è´¦æˆ·æ›´æ–°        â”‚  â”‚ â€¢ ç›¯å¸‚ç›ˆäº   â”‚  â”‚
â”‚   â”‚ â€¢ è·¯ç”±æ’®åˆ        â”‚  â”‚ â€¢ æ¨é€è®¢é˜…è€…      â”‚  â”‚ â€¢ å¼ºå¹³å¤„ç†   â”‚  â”‚
â”‚   â”‚ â€¢ çŠ¶æ€ç®¡ç†        â”‚  â”‚ â€¢ Pub/Sub        â”‚  â”‚ â€¢ ç»“ç®—å†å²   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                     â”‚                               â”‚
â”‚            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚            â”‚    â”‚  PreTradeCheck (é£æ§)     â”‚                     â”‚
â”‚            â”‚    â”‚  â€¢ èµ„é‡‘æ£€æŸ¥               â”‚                     â”‚
â”‚            â”‚    â”‚  â€¢ æŒä»“é™é¢               â”‚                     â”‚
â”‚            â”‚    â”‚  â€¢ é£é™©åº¦æ£€æŸ¥             â”‚                     â”‚
â”‚            â”‚    â”‚  â€¢ è‡ªæˆäº¤é˜²èŒƒ             â”‚                     â”‚
â”‚            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ ¸å¿ƒå±‚ (Core Layer)                           â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ AccountManager   â”‚  â”‚ MatchingEngine   â”‚  â”‚ Instrument   â”‚  â”‚
â”‚   â”‚ (è´¦æˆ·ç®¡ç†)        â”‚  â”‚ (æ’®åˆå¼•æ“)        â”‚  â”‚ Registry     â”‚  â”‚
â”‚   â”‚                  â”‚  â”‚                  â”‚  â”‚ (åˆçº¦æ³¨å†Œ) ğŸ”§â”‚  â”‚
â”‚   â”‚ â€¢ å¼€æˆ·/é”€æˆ·       â”‚  â”‚ â€¢ Orderbook      â”‚  â”‚ â€¢ åˆçº¦ä¿¡æ¯   â”‚  â”‚
â”‚   â”‚ â€¢ å…¥é‡‘/å‡ºé‡‘       â”‚  â”‚ â€¢ ä»·æ ¼æ—¶é—´ä¼˜å…ˆ    â”‚  â”‚ â€¢ ç”Ÿå‘½å‘¨æœŸ   â”‚  â”‚
â”‚   â”‚ â€¢ è´¦æˆ·æŸ¥è¯¢        â”‚  â”‚ â€¢ æ’®åˆç®—æ³•        â”‚  â”‚ â€¢ å‚æ•°é…ç½®   â”‚  â”‚
â”‚   â”‚ â€¢ æƒé™ç®¡ç†        â”‚  â”‚ â€¢ æˆäº¤ç”Ÿæˆ        â”‚  â”‚ â€¢ çŠ¶æ€ç®¡ç†   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ SettlementEngine â”‚  â”‚ RiskMonitor      â”‚  â”‚ SystemMonitorâ”‚  â”‚
â”‚   â”‚ (ç»“ç®—å¼•æ“) ğŸ”§    â”‚  â”‚ (é£æ§ç›‘æ§) ğŸ”§    â”‚  â”‚ (ç³»ç»Ÿç›‘æ§)ğŸ”§ â”‚  â”‚
â”‚   â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚  â”‚
â”‚   â”‚ â€¢ è®¾ç½®ç»“ç®—ä»·      â”‚  â”‚ â€¢ é£é™©è´¦æˆ·       â”‚  â”‚ â€¢ CPU/å†…å­˜   â”‚  â”‚
â”‚   â”‚ â€¢ æ—¥ç»ˆç»“ç®—        â”‚  â”‚ â€¢ ä¿è¯é‡‘ç›‘æ§     â”‚  â”‚ â€¢ å­˜å‚¨ç›‘æ§   â”‚  â”‚
â”‚   â”‚ â€¢ ç›ˆäºè®¡ç®—        â”‚  â”‚ â€¢ å¼ºå¹³æ£€æµ‹       â”‚  â”‚ â€¢ è´¦æˆ·ç»Ÿè®¡   â”‚  â”‚
â”‚   â”‚ â€¢ å¼ºå¹³å¤„ç†        â”‚  â”‚ â€¢ å¼ºå¹³è®°å½•       â”‚  â”‚ â€¢ æ€§èƒ½æŒ‡æ ‡   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å±‚ (Data Layer - å¤ç”¨ qars)               â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  QA_Account      â”‚  â”‚  QA_Position     â”‚  â”‚  QA_Order    â”‚  â”‚
â”‚   â”‚  (è´¦æˆ·ç»“æ„)       â”‚  â”‚  (æŒä»“ç»“æ„)       â”‚  â”‚  (è®¢å•ç»“æ„)   â”‚  â”‚
â”‚   â”‚                  â”‚  â”‚                  â”‚  â”‚              â”‚  â”‚
â”‚   â”‚ â€¢ QIFI åè®®      â”‚  â”‚ â€¢ å¤šç©ºæŒä»“        â”‚  â”‚ â€¢ è®¢å•çŠ¶æ€   â”‚  â”‚
â”‚   â”‚ â€¢ èµ„é‡‘ç®¡ç†        â”‚  â”‚ â€¢ ä»Šæ˜¨ä»“åˆ†ç¦»      â”‚  â”‚ â€¢ æˆäº¤è®°å½•   â”‚  â”‚
â”‚   â”‚ â€¢ ç›ˆäºè®¡ç®—        â”‚  â”‚ â€¢ æˆæœ¬è®¡ç®—        â”‚  â”‚ â€¢ è®¢å•ç°¿    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  æ•°æ®æŒä¹…åŒ– (å¯é€‰)                                          â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ MongoDB (è´¦æˆ·å¿«ç…§ã€è®¢å•è®°å½•)                           â”‚  â”‚
â”‚   â”‚  â”œâ”€â”€ ClickHouse (æˆäº¤è®°å½•ã€è¡Œæƒ…æ•°æ®)                        â”‚  â”‚
â”‚   â”‚  â””â”€â”€ Redis (ç¼“å­˜ã€ä¼šè¯)                                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. é«˜æ€§èƒ½ (High Performance)

**ç›®æ ‡**:
- è®¢å•ååé‡: > 100K orders/sec
- æ’®åˆå»¶è¿Ÿ: P99 < 100Î¼s
- WebSocket å¹¶å‘: > 10K connections

**å®ç°**:
- **å¼‚æ­¥éé˜»å¡**: Tokio å¼‚æ­¥è¿è¡Œæ—¶
- **é›¶æ‹·è´é€šä¿¡**: crossbeam unbounded channel
- **æ— é”å¹¶å‘**: DashMap, parking_lot RwLock
- **å†…å­˜æ± **: é¢„åˆ†é…å¯¹è±¡æ± ï¼Œå‡å°‘ GC å‹åŠ›

### 2. ç±»å‹å®‰å…¨ (Type Safety)

**ä¼˜åŠ¿**:
- **ç¼–è¯‘æ—¶ä¿è¯**: Rust ç±»å‹ç³»ç»Ÿåœ¨ç¼–è¯‘æ—¶å‘ç°é”™è¯¯
- **æ— è¿è¡Œæ—¶å¼‚å¸¸**: æ— ç©ºæŒ‡é’ˆã€æ— æ•°æ®ç«äº‰
- **å¼ºç±»å‹åè®®**: QIFI/TIFI/MIFI åè®®å®šä¹‰

**ç¤ºä¾‹**:
```rust
// ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
pub enum OrderDirection {
    BUY,
    SELL,
}

pub enum OrderOffset {
    OPEN,
    CLOSE,
    CLOSETODAY,
    CLOSEYESTERDAY,
}

// ç¼–è¯‘å™¨ç¡®ä¿åªèƒ½ä½¿ç”¨åˆæ³•å€¼
fn submit_order(direction: OrderDirection, offset: OrderOffset) {
    // ...
}
```

### 3. æ¨¡å—åŒ– (Modularity)

**åˆ†å±‚è§£è€¦**:
- **æœåŠ¡å±‚**: ä¸ä¾èµ–å…·ä½“ä¸šåŠ¡å®ç°
- **ä¸šåŠ¡å±‚**: å¯ç‹¬ç«‹æµ‹è¯•å’Œæ›¿æ¢
- **æ ¸å¿ƒå±‚**: çº¯ç²¹çš„é¢†åŸŸé€»è¾‘
- **æ•°æ®å±‚**: å¤ç”¨ qars æˆç†Ÿç»„ä»¶

### 4. å¯è§‚æµ‹æ€§ (Observability)

**æ—¥å¿—åˆ†çº§**:
```rust
log::trace!("è®¢å•ç°¿å¿«ç…§: {:?}", orderbook);
log::debug!("è®¢å• {} æäº¤æˆåŠŸ", order_id);
log::info!("è´¦æˆ· {} å¼€æˆ·æˆåŠŸ", user_id);
log::warn!("é£é™©åº¦ {:.2}% æ¥è¿‘é˜ˆå€¼", risk_ratio * 100.0);
log::error!("æ’®åˆå¼•æ“å¼‚å¸¸: {}", error);
```

**æ€§èƒ½æŒ‡æ ‡** (é¢„ç•™):
- è®¢å•æäº¤å»¶è¿Ÿåˆ†å¸ƒ
- æ’®åˆå¼•æ“ TPS
- WebSocket è¿æ¥æ•°
- å†…å­˜/CPU ä½¿ç”¨ç‡

---

## åˆ†å±‚æ¶æ„

### æœåŠ¡å±‚ (Service Layer)

**èŒè´£**: å¯¹å¤–æä¾› HTTP å’Œ WebSocket æ¥å£

**HTTP Server**:
```rust
pub struct HttpServer {
    app_state: Arc<AppState>,
    bind_address: String,
}

pub struct AppState {
    order_router: Arc<OrderRouter>,
    account_mgr: Arc<AccountManager>,
}
```

**WebSocket Server**:
```rust
pub struct WsSession {
    id: String,
    state: SessionState,  // Unauthenticated | Authenticated
    heartbeat: Instant,
    subscribed_channels: Vec<String>,
    notification_receiver: Option<Receiver<Notification>>,
}
```

### ä¸šåŠ¡å±‚ (Business Layer)

**OrderRouter (è®¢å•è·¯ç”±å™¨)**:
```rust
pub struct OrderRouter {
    account_mgr: Arc<AccountManager>,
    risk_checker: Arc<PreTradeCheck>,
    matching_engines: Arc<DashMap<String, Arc<RwLock<ExchangeMatchingEngine>>>>,
    orders: Arc<DashMap<String, OrderInfo>>,
    trade_gateway: Arc<TradeGateway>,
    order_seq: AtomicU64,
}
```

**å®Œæ•´è®¢å•æµç¨‹**:
1. æ¥æ”¶è®¢å•è¯·æ±‚
2. é£æ§æ£€æŸ¥ (PreTradeCheck)
3. è·¯ç”±åˆ°æ’®åˆå¼•æ“
4. å¤„ç†æ’®åˆç»“æœ
5. æ›´æ–°è´¦æˆ·çŠ¶æ€ (TradeGateway)
6. æ¨é€é€šçŸ¥ç»™è®¢é˜…è€…

**TradeGateway (æˆäº¤ç½‘å…³)**:
```rust
pub struct TradeGateway {
    account_mgr: Arc<AccountManager>,
    user_subscribers: Arc<DashMap<String, Vec<Sender<Notification>>>>,
    global_subscribers: Arc<DashMap<String, Sender<Notification>>>,
    trade_seq: AtomicU64,
}
```

**Pub/Sub æ¨¡å¼**:
- ç”¨æˆ·è®¢é˜…: æ¥æ”¶è‡ªå·±çš„æˆäº¤/è®¢å•çŠ¶æ€/è´¦æˆ·æ›´æ–°
- å…¨å±€è®¢é˜…: æ¥æ”¶æŒ‡å®šåˆçº¦çš„æ‰€æœ‰æˆäº¤

### æ ¸å¿ƒå±‚ (Core Layer)

**AccountManager (è´¦æˆ·ç®¡ç†å™¨)**:
```rust
pub struct AccountManager {
    accounts: Arc<DashMap<String, Arc<RwLock<QA_Account>>>>,
}

impl AccountManager {
    pub fn open_account(&self, req: OpenAccountRequest) -> Result<String, ExchangeError>;
    pub fn get_account(&self, user_id: &str) -> Result<Arc<RwLock<QA_Account>>, ExchangeError>;
    pub fn deposit(&self, user_id: &str, amount: f64) -> Result<(), ExchangeError>;
    pub fn withdraw(&self, user_id: &str, amount: f64) -> Result<(), ExchangeError>;
}
```

**MatchingEngine (æ’®åˆå¼•æ“)**:
- å¤ç”¨ qars `ExchangeMatchingEngine`
- ä»·æ ¼-æ—¶é—´ä¼˜å…ˆæ’®åˆç®—æ³•
- æ”¯æŒé™ä»·å•ã€å¸‚ä»·å•
- é›†åˆç«ä»·æ”¯æŒ (é¢„ç•™)

### æ•°æ®å±‚ (Data Layer)

**å¤ç”¨ qars æ ¸å¿ƒæ•°æ®ç»“æ„**:

**QA_Account (è´¦æˆ·)**:
```rust
pub struct QA_Account {
    pub user_id: String,
    pub accounts: Account,      // èµ„é‡‘è´¦æˆ·
    pub hold: HashMap<String, QA_Position>,  // æŒä»“
    pub trades: Vec<QA_Trade>,  // æˆäº¤è®°å½•
    pub orders: BTreeMap<String, Order>,     // è®¢å•
}
```

**Account (èµ„é‡‘ç»“æ„)**:
```rust
pub struct Account {
    pub balance: f64,        // æ€»æƒç›Š
    pub available: f64,      // å¯ç”¨èµ„é‡‘
    pub margin: f64,         // å ç”¨ä¿è¯é‡‘
    pub close_profit: f64,   // å¹³ä»“ç›ˆäº
    pub risk_ratio: f64,     // é£é™©åº¦
}
```

**QA_Position (æŒä»“)**:
```rust
pub struct QA_Position {
    pub volume_long_today: f64,      // å¤šå¤´ä»Šä»“
    pub volume_long_his: f64,        // å¤šå¤´æ˜¨ä»“
    pub volume_short_today: f64,     // ç©ºå¤´ä»Šä»“
    pub volume_short_his: f64,       // ç©ºå¤´æ˜¨ä»“
    pub open_price_long: f64,        // å¤šå¤´å¼€ä»“å‡ä»·
    pub open_price_short: f64,       // ç©ºå¤´å¼€ä»“å‡ä»·
}
```

### å­˜å‚¨å±‚ (Storage Layer)

**æ··åˆå­˜å‚¨æ¶æ„ (Hybrid OLTP/OLAP)**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Storage Layer                         â”‚
â”‚                                                              â”‚
â”‚   OLTP Path (Low Latency)      OLAP Path (Analytics)       â”‚
â”‚   â†“                             â†“                            â”‚
â”‚   WAL                           WAL                          â”‚
â”‚   â†“                             â†“                            â”‚
â”‚   MemTable (SkipMap)            MemTable (Arrow2 Columnar)  â”‚
â”‚   â†“                             â†“                            â”‚
â”‚   SSTable (rkyv + mmap)         SSTable (Parquet)           â”‚
â”‚   â†“                             â†“                            â”‚
â”‚   Compaction + Bloom Filter     Query Engine (Polars)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**WAL (Write-Ahead Log)** - `src/storage/wal/`:
```rust
pub struct WalManager {
    dir: PathBuf,
    current_file: File,
    sequence: AtomicU64,
}
```
- CRC32 æ•°æ®å®Œæ•´æ€§æ ¡éªŒ
- æ‰¹é‡å†™å…¥ä¼˜åŒ– (> 78K entries/sec)
- å´©æºƒæ¢å¤æœºåˆ¶
- P99 < 50ms å†™å…¥å»¶è¿Ÿ

**MemTable** - `src/storage/memtable/`:
- **OLTP MemTable** (`oltp.rs`): SkipMap, P99 < 10Î¼s
- **OLAP MemTable** (`olap.rs`): Arrow2 columnar format

**SSTable** - `src/storage/sstable/`:
- **OLTP SSTable** (`oltp_rkyv.rs`): rkyv é›¶æ‹·è´, P99 < 50Î¼s
- **OLAP SSTable** (`olap_parquet.rs`): Parquet åˆ—å¼å­˜å‚¨
- **Bloom Filter** (`bloom.rs`): 1% FP rate, ~100ns lookup
- **mmap Reader** (`mmap_reader.rs`): é›¶æ‹·è´æ–‡ä»¶æ˜ å°„

**Compaction** - `src/storage/compaction/`:
- Leveled compaction ç­–ç•¥
- åå°å‹ç¼©çº¿ç¨‹
- è‡ªåŠ¨è§¦å‘å’Œæ‰‹åŠ¨è§¦å‘

**Checkpoint** - `src/storage/checkpoint/`:
- å¿«ç…§åˆ›å»º
- æ¢å¤ç®¡ç†
- å¢é‡å¤‡ä»½

**Hybrid Storage** - `src/storage/hybrid/`:
```rust
pub struct OltpHybridStorage {
    wal: Arc<WalManager>,
    memtable: Arc<RwLock<OltpMemTable>>,
    sstable_dir: PathBuf,
}
```

### æŸ¥è¯¢å±‚ (Query Layer) âœ¨ Phase 8

**æŸ¥è¯¢å¼•æ“æ¶æ„** - `src/query/`:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Query Engine (Polars)                   â”‚
â”‚                                                              â”‚
â”‚   QueryRequest â”€â†’ SSTableScanner â”€â†’ LazyFrame â”€â†’ DataFrame   â”‚
â”‚        â”‚              â”‚                  â”‚            â”‚       â”‚
â”‚        â”‚              â”‚                  â”‚            â”‚       â”‚
â”‚   SQL/Struct/    OLTP + OLAP      Predicate       Column     â”‚
â”‚   TimeSeries      SSTables         Pushdown       Pruning    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**QueryEngine** - `src/query/engine.rs`:
```rust
pub struct QueryEngine {
    scanner: SSTableScanner,
}

impl QueryEngine {
    pub fn execute(&self, request: QueryRequest)
        -> Result<QueryResponse, String>;
}
```

**æŸ¥è¯¢ç±»å‹**:
1. **SQL Query**: æ ‡å‡† SQL via Polars SQLContext
```rust
QueryType::Sql {
    query: "SELECT * FROM data WHERE price > 100 LIMIT 10"
}
```

2. **Structured Query**: ç¨‹åºåŒ– API
```rust
QueryType::Structured {
    select: vec!["timestamp", "price", "volume"],
    from: "data",
}
// + filters, aggregations, order_by, limit
```

3. **Time-Series Query**: æ—¶é—´åºåˆ—èšåˆ
```rust
QueryType::TimeSeries {
    metrics: vec!["price", "volume"],
    dimensions: vec!["instrument_id"],
    granularity: Some(60), // 60ç§’ç²’åº¦
}
```

**æ€§èƒ½ä¼˜åŒ–**:
- LazyFrame å»¶è¿Ÿæ‰§è¡Œ
- Predicate pushdown (è°“è¯ä¸‹æ¨)
- Column pruning (åˆ—è£å‰ª)
- Multi-file parallel scanning
- Parquet scan throughput: > 1GB/s

### å¤åˆ¶å±‚ (Replication Layer) - Phase 6

**Master-Slave Replication** - `src/replication/`:

```rust
pub struct LogReplicator {
    role: Arc<RwLock<NodeRole>>,  // Master/Slave/Candidate
    log_buffer: Arc<RwLock<Vec<ReplicationLogEntry>>>,
}
```

**æ ¸å¿ƒèƒ½åŠ›**:
- æ‰¹é‡æ—¥å¿—å¤åˆ¶ (< 10ms å»¶è¿Ÿ)
- å¿ƒè·³æ£€æµ‹ (100ms é—´éš”)
- è‡ªåŠ¨æ•…éšœè½¬ç§» (< 500ms)
- Raft-inspired é€‰ä¸»ç®—æ³•

**è§’è‰²ç®¡ç†**:
- **Master**: æ¥æ”¶å†™å…¥, å¤åˆ¶æ—¥å¿—åˆ° Slave
- **Slave**: åªè¯», æ¥æ”¶æ—¥å¿—å¹¶åº”ç”¨
- **Candidate**: å‚ä¸é€‰ä¸»æŠ•ç¥¨

### å› å­è®¡ç®—å±‚ (Factor Layer) âœ¨ NEW

**æµæ‰¹ä¸€ä½“å› å­å¼•æ“** - `src/factor/`:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å› å­è®¡ç®—ç³»ç»Ÿæ¶æ„                            â”‚
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   DSL å±‚    â”‚    â”‚  DAG ç®¡ç†   â”‚    â”‚  çŠ¶æ€å­˜å‚¨   â”‚     â”‚
â”‚   â”‚ (è¯­æ³•è§£æ)  â”‚â”€â”€â”€â–¶â”‚ (ä¾èµ–æ‹“æ‰‘)  â”‚â”€â”€â”€â–¶â”‚ (ç‰©åŒ–è§†å›¾)  â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚                  â”‚             â”‚
â”‚         â–¼                  â–¼                  â–¼             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              æµæ‰¹ä¸€ä½“æ‰§è¡Œå¼•æ“                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚   â”‚  â”‚  Stream Engineâ”‚        â”‚  Batch Engine â”‚          â”‚   â”‚
â”‚   â”‚  â”‚  (å¢é‡ç®—å­)   â”‚        â”‚  (Polars SQL) â”‚          â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶**:
- **å¢é‡ç®—å­** (`operators/`): RollingMean, EMA, RSI, MACD ç­‰ O(1) ç®—å­
- **ç¯å½¢ç¼“å†²åŒº** (`ring_buffer.rs`): æ»‘åŠ¨çª—å£é«˜æ•ˆå®ç°
- **Welford ç®—æ³•** (`welford.rs`): æ•°å€¼ç¨³å®šçš„åœ¨çº¿ç»Ÿè®¡
- **å› å­ DAG** (`dag.rs`): ä¾èµ–ç®¡ç†ä¸å¹¶è¡Œè®¡ç®—
- **ç‰©åŒ–è§†å›¾** (`view.rs`): å› å­çŠ¶æ€æŒä¹…åŒ–

**æ€§èƒ½æŒ‡æ ‡**:
- RollingMean.update(): ~15 ns (66M ops/s)
- RollingStd.update(): ~25 ns (Welford)
- ç¯å½¢ç¼“å†²åŒº push: ~5 ns (200M ops/s)

### é›†ç¾¤ç®¡ç†å±‚ (Cluster Layer) âœ¨ NEW

**ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡** - `src/cluster/`:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é›†ç¾¤æ¶æ„                                   â”‚
â”‚                                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚ ShardRouter â”‚ â—€â”€â”€â”€ è·¯ç”±ç¼“å­˜                             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚   ConsistentHashRing        â”‚                          â”‚
â”‚    â”‚  0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2^64      â”‚                          â”‚
â”‚    â”‚  â”‚  N1  N2  N3  N1  N2  N3  â”‚ â—€â”€â”€â”€ è™šæ‹ŸèŠ‚ç‚¹             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚          â”‚                                                   â”‚
â”‚          â–¼                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚  Node1  â”‚  â”‚  Node2  â”‚  â”‚  Node3  â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒèƒ½åŠ›**:
- **ä¸€è‡´æ€§å“ˆå¸Œ**: èŠ‚ç‚¹å˜æ›´æ—¶æœ€å°åŒ–æ•°æ®è¿ç§»
- **è™šæ‹ŸèŠ‚ç‚¹**: 150 ä¸ªè™šæ‹ŸèŠ‚ç‚¹/ç‰©ç†èŠ‚ç‚¹
- **å¸¦æƒé‡èŠ‚ç‚¹**: é«˜æ€§èƒ½èŠ‚ç‚¹æ‰¿æ‹…æ›´å¤šè´Ÿè½½
- **å‰¯æœ¬åˆ†å¸ƒ**: å¤šå‰¯æœ¬é«˜å¯é æ€§
- **åˆ†ç‰‡è·¯ç”±**: æŒ‰è´¦æˆ·ID/åˆçº¦ID/è®¢å•IDåˆ†ç‰‡

**æ€§èƒ½æŒ‡æ ‡**:
- `get_node()`: ~100 ns
- `route()` ç¼“å­˜å‘½ä¸­: ~20 ns
- `add_node()`: ~1 ms

### DSL å±‚ (DSL Layer) âœ¨ NEW

**å› å­å®šä¹‰è¯­è¨€** - `src/dsl/`:

```rust
// DSL ç¤ºä¾‹
ma5 = rolling_mean(close, 5)
ma20 = rolling_mean(close, 20)
ma_diff = ma5 - ma20
signal = if rsi > 70 then -1 else if rsi < 30 then 1 else 0
```

**æ ¸å¿ƒç»„ä»¶**:
- **è¯æ³•åˆ†æå™¨** (`lexer.rs`): Token ç”Ÿæˆ
- **è¯­æ³•è§£æå™¨** (`parser.rs`): AST æ„å»º (pest)
- **è¯­æ³•å®šä¹‰** (`grammar.pest`): PEG è¯­æ³•è§„åˆ™

---

## ç®¡ç†ç«¯æ¶æ„

### æ¦‚è¿°

ç®¡ç†ç«¯æä¾›åˆçº¦ç®¡ç†ã€ç»“ç®—ç®¡ç†ã€é£æ§ç›‘æ§å’Œç³»ç»Ÿç›‘æ§ç­‰ç®¡ç†å‘˜åŠŸèƒ½ï¼Œç¡®ä¿äº¤æ˜“æ‰€çš„ç¨³å®šè¿è¡Œå’Œåˆè§„æ“ä½œã€‚

### ç®¡ç†ç«¯æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç®¡ç†ç«¯æ•°æ®æµ                              â”‚
â”‚                                                                â”‚
â”‚  ç®¡ç†å‘˜ â†’ å‰ç«¯ç•Œé¢ â†’ HTTP API â†’ ç®¡ç†ç«¯æ¨¡å— â†’ æ ¸å¿ƒå¼•æ“ â†’ å­˜å‚¨   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç®¡ç†å‘˜  â”‚ â†’ â”‚ Admin UI â”‚ â†’ â”‚ Admin API   â”‚ â†’ â”‚  Core   â”‚ â”‚
â”‚  â”‚         â”‚   â”‚          â”‚   â”‚             â”‚   â”‚ Engines â”‚ â”‚
â”‚  â”‚ â€¢ åˆçº¦  â”‚   â”‚ â€¢ Vue.js â”‚   â”‚ â€¢ Actix-web â”‚   â”‚         â”‚ â”‚
â”‚  â”‚ â€¢ ç»“ç®—  â”‚   â”‚ â€¢ Elementâ”‚   â”‚ â€¢ REST      â”‚   â”‚ â€¢ è´¦æˆ·  â”‚ â”‚
â”‚  â”‚ â€¢ é£æ§  â”‚   â”‚   UI     â”‚   â”‚ â€¢ JSON      â”‚   â”‚ â€¢ æ’®åˆ  â”‚ â”‚
â”‚  â”‚ â€¢ ç›‘æ§  â”‚   â”‚ â€¢ EChartsâ”‚   â”‚             â”‚   â”‚ â€¢ å­˜å‚¨  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—

#### 1. InstrumentRegistry (åˆçº¦æ³¨å†Œè¡¨)

**èŒè´£**: ç®¡ç†åˆçº¦çš„å…¨ç”Ÿå‘½å‘¨æœŸ

**æ ¸å¿ƒåŠŸèƒ½**:
```rust
pub struct InstrumentRegistry {
    instruments: Arc<DashMap<String, InstrumentInfo>>,
}

impl InstrumentRegistry {
    // åˆçº¦æ³¨å†Œä¸ç®¡ç†
    pub fn register(&self, instrument: InstrumentInfo) -> Result<()>
    pub fn update(&self, id: &str, updater: impl FnOnce(&mut InstrumentInfo)) -> Result<()>

    // çŠ¶æ€ç®¡ç†
    pub fn suspend(&self, id: &str) -> Result<()>  // æš‚åœäº¤æ˜“
    pub fn resume(&self, id: &str) -> Result<()>   // æ¢å¤äº¤æ˜“
    pub fn delist(&self, id: &str) -> Result<()>   // ä¸‹å¸‚åˆçº¦

    // æŸ¥è¯¢
    pub fn get(&self, id: &str) -> Option<InstrumentInfo>
    pub fn list_all(&self) -> Vec<InstrumentInfo>
}
```

**åˆçº¦ç”Ÿå‘½å‘¨æœŸ**:
```
åˆ›å»º â†’ ä¸Šå¸‚ â†’ äº¤æ˜“ä¸­ â‡„ æš‚åœ â†’ ä¸‹å¸‚
     (register) (Trading) (Suspended) (Delisted)
```

**ä¸‹å¸‚å®‰å…¨æ£€æŸ¥**:
- éå†æ‰€æœ‰è´¦æˆ·
- æ£€æŸ¥æ˜¯å¦æœ‰æœªå¹³ä»“æŒä»“
- è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆåŒ…å«æŒä»“è´¦æˆ·åˆ—è¡¨ï¼‰
- é˜²æ­¢æ•°æ®ä¸ä¸€è‡´

---

#### 2. SettlementEngine (ç»“ç®—å¼•æ“)

**èŒè´£**: æ‰§è¡Œæ—¥ç»ˆç»“ç®—å’Œå¼ºå¹³å¤„ç†

**æ ¸å¿ƒåŠŸèƒ½**:
```rust
pub struct SettlementEngine {
    account_mgr: Arc<AccountManager>,
    settlement_prices: Arc<DashMap<String, f64>>,
    settlement_history: Arc<DashMap<String, SettlementResult>>,
    force_close_threshold: f64,  // å¼ºå¹³é˜ˆå€¼ï¼ˆé»˜è®¤1.0 = 100%ï¼‰
}

impl SettlementEngine {
    // ç»“ç®—ä»·ç®¡ç†
    pub fn set_settlement_price(&self, instrument_id: String, price: f64)
    pub fn set_settlement_prices(&self, prices: HashMap<String, f64>)

    // æ—¥ç»ˆç»“ç®—
    pub fn daily_settlement(&self) -> Result<SettlementResult>

    // å•ä¸ªè´¦æˆ·ç»“ç®—
    fn settle_account(&self, user_id: &str, date: &str) -> Result<AccountSettlement>

    // å¼ºå¹³å¤„ç†
    pub fn force_close_account(&self, user_id: &str) -> Result<()>

    // æŸ¥è¯¢
    pub fn get_settlement_history(&self) -> Vec<SettlementResult>
    pub fn get_settlement_detail(&self, date: &str) -> Option<SettlementResult>
}
```

**ç»“ç®—æµç¨‹**:
```
1. è®¾ç½®ç»“ç®—ä»·
   â†“
2. éå†æ‰€æœ‰è´¦æˆ·
   â†“
3. è®¡ç®—æŒä»“ç›ˆäºï¼ˆç›¯å¸‚ï¼‰
   â€¢ å¤šå¤´ç›ˆäº = (ç»“ç®—ä»· - å¼€ä»“ä»·) Ã— å¤šå¤´æ•°é‡ Ã— åˆçº¦ä¹˜æ•°
   â€¢ ç©ºå¤´ç›ˆäº = (å¼€ä»“ä»· - ç»“ç®—ä»·) Ã— ç©ºå¤´æ•°é‡ Ã— åˆçº¦ä¹˜æ•°
   â†“
4. è®¡ç®—ç´¯è®¡æ‰‹ç»­è´¹
   â€¢ ä»è´¦æˆ·ç´¯è®¡å€¼è·å–
   â†“
5. æ›´æ–°è´¦æˆ·æƒç›Š
   â€¢ æ–°æƒç›Š = åŸæƒç›Š + æŒä»“ç›ˆäº + å¹³ä»“ç›ˆäº - æ‰‹ç»­è´¹
   â†“
6. è®¡ç®—é£é™©åº¦
   â€¢ é£é™©åº¦ = å ç”¨ä¿è¯é‡‘ / è´¦æˆ·æƒç›Š
   â†“
7. æ£€æŸ¥å¼ºå¹³
   â€¢ å¦‚æœé£é™©åº¦ >= 100%ï¼Œè®°å½•å¼ºå¹³è´¦æˆ·
   â†“
8. ä¿å­˜ç»“ç®—ç»“æœ
   â€¢ æ€»è´¦æˆ·æ•°ã€æˆåŠŸæ•°ã€å¤±è´¥æ•°
   â€¢ å¼ºå¹³è´¦æˆ·åˆ—è¡¨
   â€¢ æ€»æ‰‹ç»­è´¹ã€æ€»ç›ˆäº
```

**å¼ºå¹³å¤„ç†**:
- è‡ªåŠ¨è¯†åˆ«é£é™©åº¦ >= 100% çš„è´¦æˆ·
- è®°å½•åˆ° `force_closed_accounts` åˆ—è¡¨
- å¯é…ç½®å¼ºå¹³é˜ˆå€¼

---

#### 3. RiskMonitor (é£æ§ç›‘æ§) âš ï¸ éƒ¨åˆ†å®ç°

**èŒè´£**: å®æ—¶ç›‘æ§è´¦æˆ·é£é™©

**è§„åˆ’åŠŸèƒ½**:
```rust
pub struct RiskMonitor {
    account_mgr: Arc<AccountManager>,
    risk_threshold: f64,
}

impl RiskMonitor {
    // é£é™©è´¦æˆ·ç­›é€‰
    pub fn get_risk_accounts(&self, threshold: f64) -> Vec<RiskAccount>

    // ä¿è¯é‡‘ç›‘æ§æ±‡æ€»
    pub fn get_margin_summary(&self) -> MarginSummary

    // å¼ºå¹³è®°å½•
    pub fn get_liquidation_records(&self, start_date: &str, end_date: &str)
        -> Vec<LiquidationRecord>
}
```

**é£é™©ç­‰çº§**:
- **æ­£å¸¸**: é£é™©åº¦ < 50%
- **è­¦å‘Š**: 50% â‰¤ é£é™©åº¦ < 80%
- **é«˜é£é™©**: 80% â‰¤ é£é™©åº¦ < 100%
- **å¼ºå¹³**: é£é™©åº¦ >= 100%

**çŠ¶æ€**: å‰ç«¯å·²å®ç°ï¼Œåç«¯APIå¾…å¼€å‘

---

#### 4. SystemMonitor (ç³»ç»Ÿç›‘æ§)

**èŒè´£**: ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

**æ ¸å¿ƒåŠŸèƒ½**:
```rust
pub struct SystemMonitor {
    account_mgr: Arc<AccountManager>,
    storage_subscriber: Arc<StorageSubscriber>,
}

impl SystemMonitor {
    // ç³»ç»ŸçŠ¶æ€
    pub fn get_system_status(&self) -> SystemStatus {
        SystemStatus {
            cpu_usage: get_cpu_usage(),
            memory_usage: get_memory_usage(),
            disk_usage: get_disk_usage(),
            uptime: get_uptime(),
            process_count: get_process_count(),
        }
    }

    // å­˜å‚¨ç›‘æ§
    pub fn get_storage_status(&self) -> StorageStatus {
        let stats = self.storage_subscriber.get_stats();
        StorageStatus {
            wal_size: stats.wal_size,
            wal_files: stats.wal_files,
            memtable_size: stats.memtable_size,
            memtable_entries: stats.memtable_entries,
            sstable_count: stats.sstable_count,
            sstable_size: stats.sstable_size,
        }
    }

    // è´¦æˆ·ç›‘æ§
    pub fn get_account_stats(&self) -> AccountStats

    // è®¢å•ç›‘æ§
    pub fn get_order_stats(&self) -> OrderStats

    // æˆäº¤ç›‘æ§
    pub fn get_trade_stats(&self) -> TradeStats

    // ç”ŸæˆæŠ¥å‘Š
    pub fn generate_report(&self) -> MonitoringReport
}
```

**ç›‘æ§æŒ‡æ ‡**:
```
ç³»ç»Ÿå±‚:
â€¢ CPUä½¿ç”¨ç‡
â€¢ å†…å­˜ä½¿ç”¨ç‡
â€¢ ç£ç›˜ä½¿ç”¨ç‡
â€¢ è¿è¡Œæ—¶é—´
â€¢ è¿›ç¨‹æ•°

å­˜å‚¨å±‚:
â€¢ WALå¤§å°å’Œæ–‡ä»¶æ•°
â€¢ MemTableå¤§å°å’Œæ¡ç›®æ•°
â€¢ SSTableæ•°é‡å’Œæ€»å¤§å°

ä¸šåŠ¡å±‚:
â€¢ è´¦æˆ·æ€»æ•°/æ´»è·ƒæ•°
â€¢ æ€»èµ„é‡‘/æ€»ä¿è¯é‡‘
â€¢ è®¢å•æ€»æ•°/å¾…å¤„ç†æ•°
â€¢ æˆäº¤æ€»æ•°/æ€»æˆäº¤é¢
```

---

### ç®¡ç†ç«¯APIè·¯ç”±

| åŠŸèƒ½æ¨¡å— | APIè·¯ç”± | æ•°é‡ | çŠ¶æ€ |
|---------|---------|------|------|
| åˆçº¦ç®¡ç† | `/admin/instruments/*` | 6ä¸ª | âœ… |
| ç»“ç®—ç®¡ç† | `/admin/settlement/*` | 5ä¸ª | âœ… |
| é£æ§ç®¡ç† | `/admin/risk/*` | 3ä¸ª | âš ï¸ |
| ç³»ç»Ÿç›‘æ§ | `/monitoring/*` | 6ä¸ª | âœ… |

**æƒé™æ§åˆ¶**:
- ç®¡ç†ç«¯APIéœ€è¦ç®¡ç†å‘˜æƒé™
- TokenéªŒè¯ (JWT)
- æ“ä½œå®¡è®¡æ—¥å¿—

---

### ç®¡ç†ç«¯å‰ç«¯é¡µé¢

| é¡µé¢ | è·¯ç”± | åŠŸèƒ½ | çŠ¶æ€ |
|-----|------|------|------|
| åˆçº¦ç®¡ç† | `/admin-instruments` | åˆçº¦CRUDã€çŠ¶æ€ç®¡ç† | âœ… |
| ç»“ç®—ç®¡ç† | `/admin-settlement` | è®¾ç½®ç»“ç®—ä»·ã€æ‰§è¡Œç»“ç®—ã€æŸ¥è¯¢å†å² | âœ… |
| é£æ§ç›‘æ§ | `/admin-risk` | é£é™©è´¦æˆ·ã€ä¿è¯é‡‘ç›‘æ§ã€å¼ºå¹³è®°å½• | âœ… |
| è´¦æˆ·ç®¡ç† | `/admin-accounts` | è´¦æˆ·åˆ—è¡¨ã€è¯¦æƒ…ã€å®¡æ ¸ | âœ… |
| äº¤æ˜“ç®¡ç† | `/admin-transactions` | å…¨å¸‚åœºæˆäº¤ã€è®¢å•ç»Ÿè®¡ | âœ… |
| ç³»ç»Ÿç›‘æ§ | `/monitoring` | ç³»ç»Ÿ/å­˜å‚¨/ä¸šåŠ¡ç›‘æ§ | âœ… |

**æŠ€æœ¯æ ˆ**:
- Vue 2.6.11
- Element UI
- vxe-table
- ECharts

---

### æ•°æ®æµç¤ºä¾‹ï¼šæ—¥ç»ˆç»“ç®—

```
1. ç®¡ç†å‘˜è®¾ç½®ç»“ç®—ä»·
   POST /admin/settlement/batch-set-prices
   {
     "prices": [
       { "instrument_id": "IF2501", "settlement_price": 3850.0 },
       { "instrument_id": "IH2501", "settlement_price": 2650.0 }
     ]
   }
   â†“
2. SettlementEngine å­˜å‚¨ç»“ç®—ä»·
   settlement_prices.insert("IF2501", 3850.0)
   settlement_prices.insert("IH2501", 2650.0)
   â†“
3. ç®¡ç†å‘˜æ‰§è¡Œç»“ç®—
   POST /admin/settlement/execute
   â†“
4. SettlementEngine éå†è´¦æˆ·
   accounts = account_mgr.get_all_accounts()
   for account in accounts {
       settle_account(account)
   }
   â†“
5. è®¡ç®—ç›ˆäºå¹¶æ›´æ–°è´¦æˆ·
   â€¢ æŒä»“ç›ˆäº = f(ç»“ç®—ä»·, å¼€ä»“ä»·, æ•°é‡)
   â€¢ æ–°æƒç›Š = åŸæƒç›Š + ç›ˆäº - æ‰‹ç»­è´¹
   â€¢ é£é™©åº¦ = ä¿è¯é‡‘ / æƒç›Š
   â†“
6. è¯†åˆ«å¼ºå¹³è´¦æˆ·
   if risk_ratio >= 100% {
       force_closed_accounts.push(user_id)
   }
   â†“
7. è¿”å›ç»“ç®—ç»“æœ
   {
     "settlement_date": "2025-10-05",
     "total_accounts": 1250,
     "settled_accounts": 1247,
     "failed_accounts": 3,
     "force_closed_accounts": ["user123", "user456"],
     "total_commission": 152340.50,
     "total_profit": -234560.75
   }
```

---

## æ•°æ®æµè®¾è®¡

### è®¢å•æäº¤æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1. POST /api/order/submit
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP Handler           â”‚
â”‚  (handlers::submit_order)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. SubmitOrderRequest
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OrderRouter            â”‚
â”‚  .submit_order()        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. ç”Ÿæˆè®¢å•ID (åŸå­é€’å¢)
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â–¼
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚ PreTradeCheckâ”‚
     â”‚              â”‚ .check()     â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚
     â”‚ 4. RiskCheckResult  â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 5. é€šè¿‡ â†’ åˆ›å»ºè®¢å•
     â”‚    æ‹’ç» â†’ è¿”å›é”™è¯¯
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â–¼
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚         â”‚ MatchingEngine    â”‚
     â”‚         â”‚ .process_order()  â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚
     â”‚ 6. Vec<Result>  â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â–¼
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚         â”‚ TradeGateway      â”‚
     â”‚         â”‚ .handle_filled()  â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚
     â”‚                 â”œâ”€ 7a. æ›´æ–°è´¦æˆ·
     â”‚                 â”œâ”€ 7b. æ¨é€æˆäº¤é€šçŸ¥
     â”‚                 â””â”€ 7c. æ¨é€è´¦æˆ·æ›´æ–°
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket Subscribers  â”‚
â”‚  (å®æ—¶æ¥æ”¶é€šçŸ¥)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket å®æ—¶æ¨é€æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚ 1. WebSocket è¿æ¥
     â”‚    ws://localhost:8081/ws?user_id=user001
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WsSession (Actor)      â”‚
â”‚  .started()             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 2. æ³¨å†Œåˆ° WebSocketServer
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                     â–¼
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚         â”‚ TradeGateway      â”‚
     â”‚         â”‚ .subscribe()      â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 3. å®¢æˆ·ç«¯å‘é€è®¤è¯
     â”‚    { "type": "auth", "user_id": "...", "token": "..." }
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WsMessageHandler       â”‚
â”‚  .handle_message()      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. éªŒè¯ Token
     â”‚    SessionState â†’ Authenticated
     â”‚
     â”‚ 5. å®¢æˆ·ç«¯è®¢é˜…
     â”‚    { "type": "subscribe", "channels": ["trade", "account_update"] }
     â”‚
     â”‚ 6. å½“æœ‰æˆäº¤æ—¶
     â”‚    TradeGateway.send_notification()
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                          â–¼
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚ crossbeam::channel   â”‚
     â”‚              â”‚ (Sender â†’ Receiver)  â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                         â”‚
     â”‚ 7. WsSession.started()  â”‚
     â”‚    10ms è½®è¯¢æ¥æ”¶         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯          â”‚
â”‚  ws.onmessage()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¹¶å‘æ¨¡å‹

### 1. Actor æ¨¡å‹ (WebSocket ä¼šè¯)

**Actix Actor**:
- æ¯ä¸ª WebSocket è¿æ¥ = 1 ä¸ª Actor
- Actor ä¹‹é—´é€šè¿‡æ¶ˆæ¯ä¼ é€’é€šä¿¡
- è‡ªåŠ¨å¤„ç†å¹¶å‘ï¼Œæ— éœ€æ‰‹åŠ¨åŠ é”

```rust
impl Actor for WsSession {
    type Context = ws::WebsocketContext<Self>;

    fn started(&mut self, ctx: &mut Self::Context) {
        // å¯åŠ¨å¿ƒè·³
        self.start_heartbeat(ctx);

        // è½®è¯¢é€šçŸ¥
        ctx.run_interval(Duration::from_millis(10), |act, ctx| {
            // éé˜»å¡æ¥æ”¶
            while let Ok(notification) = act.notification_receiver.try_recv() {
                // å‘é€ç»™å®¢æˆ·ç«¯
            }
        });
    }
}
```

### 2. æ— é”å¹¶å‘ (DashMap)

**DashMap ä¼˜åŠ¿**:
- åˆ†æ®µé”è®¾è®¡ï¼Œå¹¶å‘è¯»å†™æ€§èƒ½ä¼˜å¼‚
- æ— éœ€æ‰‹åŠ¨åŠ é”ï¼ŒAPI è‡ªåŠ¨å¤„ç†
- é€‚åˆé«˜å¹¶å‘åœºæ™¯

```rust
// è®¢å•å­˜å‚¨
orders: Arc<DashMap<String, OrderInfo>>

// å¹¶å‘è¯»å†™æ— éœ€é”
self.orders.insert(order_id.clone(), order_info);
let order = self.orders.get(&order_id);
```

### 3. è¯»å†™é” (RwLock)

**parking_lot RwLock**:
- æ¯”æ ‡å‡†åº“ RwLock æ€§èƒ½æ›´å¥½
- è¯»é”å¯å¹¶å‘ï¼Œå†™é”ç‹¬å 

```rust
// è´¦æˆ·å­˜å‚¨
accounts: Arc<DashMap<String, Arc<RwLock<QA_Account>>>>

// è¯»æ“ä½œï¼ˆå¹¶å‘ï¼‰
let account = self.account_mgr.get_account(user_id)?;
let acc = account.read();  // å¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è¯»
let balance = acc.accounts.balance;

// å†™æ“ä½œï¼ˆç‹¬å ï¼‰
let mut acc = account.write();  // ç‹¬å é”
acc.accounts.balance += 10000.0;
drop(acc);  // å°½æ—©é‡Šæ”¾é”
```

### 4. åŸå­æ“ä½œ (AtomicU64)

**æ— é”é€’å¢**:
```rust
order_seq: AtomicU64

// åŸå­é€’å¢ç”Ÿæˆè®¢å•ID
let seq = self.order_seq.fetch_add(1, Ordering::SeqCst);
let order_id = format!("O{}{:016}", timestamp, seq);
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†

**é¿å…é¢‘ç¹åˆ†é…**:
```rust
// é¢„åˆ†é…å®¹é‡
let mut orders = Vec::with_capacity(1000);

// å¯¹è±¡æ± å¤ç”¨
let order = order_pool.acquire();
```

**å°½æ—©é‡Šæ”¾é”**:
```rust
{
    let acc = account.read();
    let balance = acc.accounts.balance;  // è·å–æ•°æ®
}  // acc è¢« dropï¼Œé”è¢«é‡Šæ”¾

process_balance(balance);  // æ— é”æ“ä½œ
```

### 2. å¼‚æ­¥éé˜»å¡

**Tokio å¼‚æ­¥è¿è¡Œæ—¶**:
```rust
#[tokio::main]
async fn main() {
    // HTTP æœåŠ¡å™¨å¼‚æ­¥è¿è¡Œ
    let http_server = HttpServer::new(...);
    tokio::spawn(async move {
        http_server.run().await.unwrap();
    });

    // WebSocket æœåŠ¡å™¨å¼‚æ­¥è¿è¡Œ
    let ws_server = WebSocketServer::new(...);
    tokio::spawn(async move {
        ws_server.run().await.unwrap();
    });

    // ç­‰å¾…æ‰€æœ‰æœåŠ¡
    tokio::signal::ctrl_c().await.unwrap();
}
```

### 3. é›¶æ‹·è´é€šä¿¡

**crossbeam unbounded channel**:
```rust
// å‘é€ç«¯
let (tx, rx) = crossbeam::channel::unbounded();
tx.send(notification).unwrap();  // éé˜»å¡

// æ¥æ”¶ç«¯
while let Ok(msg) = rx.try_recv() {  // éé˜»å¡
    process(msg);
}
```

### 4. æ‰¹é‡å¤„ç†

**æ‰¹é‡æ’®åˆ**:
```rust
// æ”¶é›†ä¸€æ‰¹è®¢å•
let mut batch = Vec::with_capacity(100);
while batch.len() < 100 {
    if let Ok(order) = order_rx.try_recv() {
        batch.push(order);
    } else {
        break;
    }
}

// æ‰¹é‡å¤„ç†
for order in batch {
    matching_engine.process_order(order);
}
```

---

## æ‰©å±•æ€§è®¾è®¡

### 1. æ°´å¹³æ‰©å±•

**å¤šå®ä¾‹éƒ¨ç½²**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Instance 1 â”‚      â”‚  Instance 2 â”‚      â”‚  Instance 3 â”‚
â”‚  HTTP:8080  â”‚      â”‚  HTTP:8080  â”‚      â”‚  HTTP:8080  â”‚
â”‚  WS:8081    â”‚      â”‚  WS:8081    â”‚      â”‚  WS:8081    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Load Balancer   â”‚
                  â”‚   (Nginx/HAProxy) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„äº‹é¡¹**:
- WebSocket éœ€è¦ sticky session
- è®¢å•è·¯ç”±éœ€è¦ç¡®ä¿åŒä¸€ç”¨æˆ·è¯·æ±‚åˆ°åŒä¸€å®ä¾‹
- å…±äº«çŠ¶æ€é€šè¿‡ Redis åŒæ­¥

### 2. å‚ç›´æ‰©å±•

**æ¨¡å—æ‹†åˆ†**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway       â”‚  (API ç½‘å…³)
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                â”‚
â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Trading  â”‚  â”‚ Market   â”‚  (äº¤æ˜“æœåŠ¡ | è¡Œæƒ…æœåŠ¡)
â”‚ Service  â”‚  â”‚ Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ’ä»¶åŒ–

**æ’®åˆå¼•æ“å¯æ›¿æ¢**:
```rust
pub trait MatchingEngine {
    fn process_order(&mut self, order: Order) -> Vec<Result<Success, Failed>>;
}

// é»˜è®¤å®ç°
struct DefaultMatchingEngine { ... }

// è‡ªå®šä¹‰å®ç°
struct CustomMatchingEngine { ... }
```

**é£æ§ç­–ç•¥å¯é…ç½®**:
```rust
pub struct RiskConfig {
    pub max_position_ratio: f64,
    pub risk_ratio_reject: f64,
    // ... å¯é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€åŠ è½½
}
```

---

## å®‰å…¨è®¾è®¡

### 1. è®¤è¯æˆæƒ

**Token è®¤è¯**:
```rust
// WebSocket è®¤è¯
ClientMessage::Auth { user_id, token } => {
    if verify_token(&user_id, &token) {
        session.state = SessionState::Authenticated { user_id };
    }
}
```

### 2. é£æ§ä¿æŠ¤

**å¤šå±‚é£æ§**:
1. **ç›˜å‰é£æ§**: PreTradeCheck æ£€æŸ¥èµ„é‡‘ã€æŒä»“ã€é£é™©åº¦
2. **ç›˜ä¸­ç›‘æ§**: å®æ—¶è®¡ç®—é£é™©åº¦ï¼Œæ¥è¿‘é˜ˆå€¼é¢„è­¦
3. **å¼ºå¹³æœºåˆ¶**: é£é™©åº¦è¶…é™è‡ªåŠ¨å¼ºå¹³

### 3. å‚æ•°æ ¡éªŒ

**ä¸¥æ ¼æ ¡éªŒ**:
```rust
fn check_order_params(req: &OrderCheckRequest) -> Result<(), ExchangeError> {
    if req.volume < config.min_order_volume {
        return Err(ExchangeError::InvalidOrderParams("æ•°é‡è¿‡å°".into()));
    }
    if req.price <= 0.0 {
        return Err(ExchangeError::InvalidOrderParams("ä»·æ ¼éæ³•".into()));
    }
    Ok(())
}
```

---

## æ•°æ®åè®®

### QIFI (Quantitative Investment Format Interface)

**è´¦æˆ·æ ‡å‡†æ ¼å¼**:
```json
{
  "account_cookie": "user001",
  "portfolio": "default",
  "account_type": "individual",
  "money": 1000000.0,
  "available": 950000.0,
  "margin": 50000.0,
  "positions": [
    {
      "instrument_id": "IX2301",
      "volume_long": 10,
      "volume_short": 0,
      "open_price_long": 120.0,
      "profit": 500.0
    }
  ],
  "trades": [ ... ],
  "orders": [ ... ]
}
```

---

**æ–‡æ¡£æ›´æ–°**: 2025-10-03
**ç»´æŠ¤è€…**: @yutiansut
